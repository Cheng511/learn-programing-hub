[ä¸Šä¸€ç« ï¼šç¶²çµ¡å®‰å…¨é€²éš](071_ç¶²çµ¡å®‰å…¨é€²éš.md) | [ä¸‹ä¸€ç« ï¼šç¶²çµ¡æ”»é˜²é€²éš](073_ç¶²çµ¡æ”»é˜²é€²éš.md)

# Python ç¶²çµ¡æ”»é˜²åŸºç¤ ğŸ›¡ï¸

## ç«¯å£æƒæ

### 1. TCPç«¯å£æƒæ

```python
import socket
import threading
from typing import List, Tuple
import time

class PortScanner:
    def __init__(self, target: str, start_port: int = 1, end_port: int = 1024):
        """åˆå§‹åŒ–ç«¯å£æƒæå™¨"""
        self.target = target
        self.start_port = start_port
        self.end_port = end_port
        self.open_ports: List[int] = []
        self.lock = threading.Lock()
    
    def scan_port(self, port: int) -> bool:
        """æƒæå–®å€‹ç«¯å£"""
        try:
            # å‰µå»ºTCPå¥—æ¥å­—
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)  # è¨­ç½®è¶…æ™‚æ™‚é–“
            
            # å˜—è©¦é€£æ¥
            result = sock.connect_ex((self.target, port))
            
            # é—œé–‰å¥—æ¥å­—
            sock.close()
            
            # æª¢æŸ¥çµæœ
            if result == 0:
                with self.lock:
                    self.open_ports.append(port)
                return True
            return False
        
        except Exception as e:
            print(f"Error scanning port {port}: {e}")
            return False
    
    def scan_range(self) -> List[int]:
        """æƒæç«¯å£ç¯„åœ"""
        threads = []
        
        # å‰µå»ºæƒæç·šç¨‹
        for port in range(self.start_port, self.end_port + 1):
            thread = threading.Thread(
                target=self.scan_port,
                args=(port,)
            )
            threads.append(thread)
            thread.start()
        
        # ç­‰å¾…æ‰€æœ‰ç·šç¨‹å®Œæˆ
        for thread in threads:
            thread.join()
        
        return sorted(self.open_ports)
    
    def get_service_name(self, port: int) -> str:
        """ç²å–ç«¯å£å°æ‡‰çš„æœå‹™åç¨±"""
        try:
            return socket.getservbyport(port)
        except:
            return "unknown"

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºæƒæå™¨
    scanner = PortScanner("localhost", 1, 1024)
    
    print(f"Starting port scan on {scanner.target}...")
    start_time = time.time()
    
    # åŸ·è¡Œæƒæ
    open_ports = scanner.scan_range()
    
    # è¨ˆç®—æƒææ™‚é–“
    scan_time = time.time() - start_time
    
    # è¼¸å‡ºçµæœ
    print(f"\nScan completed in {scan_time:.2f} seconds")
    print(f"Found {len(open_ports)} open ports:")
    
    for port in open_ports:
        service = scanner.get_service_name(port)
        print(f"Port {port}/tcp\t{service}")

if __name__ == '__main__':
    main()
```

### 2. UDPç«¯å£æƒæ

```python
import socket
import threading
from typing import List, Tuple
import time

class UDPScanner:
    def __init__(self, target: str, start_port: int = 1, end_port: int = 1024):
        """åˆå§‹åŒ–UDPç«¯å£æƒæå™¨"""
        self.target = target
        self.start_port = start_port
        self.end_port = end_port
        self.open_ports: List[int] = []
        self.lock = threading.Lock()
    
    def scan_port(self, port: int) -> bool:
        """æƒæå–®å€‹UDPç«¯å£"""
        try:
            # å‰µå»ºUDPå¥—æ¥å­—
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(1)  # è¨­ç½®è¶…æ™‚æ™‚é–“
            
            # ç™¼é€ç©ºæ•¸æ“šåŒ…
            sock.sendto(b"", (self.target, port))
            
            try:
                # å˜—è©¦æ¥æ”¶éŸ¿æ‡‰
                data, addr = sock.recvfrom(1024)
                with self.lock:
                    self.open_ports.append(port)
                return True
            except socket.timeout:
                # è¶…æ™‚å¯èƒ½è¡¨ç¤ºç«¯å£é–‹æ”¾
                with self.lock:
                    self.open_ports.append(port)
                return True
            except:
                return False
            finally:
                sock.close()
        
        except Exception as e:
            print(f"Error scanning port {port}: {e}")
            return False
    
    def scan_range(self) -> List[int]:
        """æƒæç«¯å£ç¯„åœ"""
        threads = []
        
        # å‰µå»ºæƒæç·šç¨‹
        for port in range(self.start_port, self.end_port + 1):
            thread = threading.Thread(
                target=self.scan_port,
                args=(port,)
            )
            threads.append(thread)
            thread.start()
        
        # ç­‰å¾…æ‰€æœ‰ç·šç¨‹å®Œæˆ
        for thread in threads:
            thread.join()
        
        return sorted(self.open_ports)
    
    def get_service_name(self, port: int) -> str:
        """ç²å–ç«¯å£å°æ‡‰çš„æœå‹™åç¨±"""
        try:
            return socket.getservbyport(port, "udp")
        except:
            return "unknown"

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºæƒæå™¨
    scanner = UDPScanner("localhost", 1, 1024)
    
    print(f"Starting UDP port scan on {scanner.target}...")
    start_time = time.time()
    
    # åŸ·è¡Œæƒæ
    open_ports = scanner.scan_range()
    
    # è¨ˆç®—æƒææ™‚é–“
    scan_time = time.time() - start_time
    
    # è¼¸å‡ºçµæœ
    print(f"\nScan completed in {scan_time:.2f} seconds")
    print(f"Found {len(open_ports)} open ports:")
    
    for port in open_ports:
        service = scanner.get_service_name(port)
        print(f"Port {port}/udp\t{service}")

if __name__ == '__main__':
    main()
```

## ç¶²çµ¡å—…æ¢

### 1. æ•¸æ“šåŒ…æ•ç²

```python
from scapy.all import *
from typing import Callable, Optional
import threading
import time

class PacketSniffer:
    def __init__(self, interface: str = "eth0"):
        """åˆå§‹åŒ–æ•¸æ“šåŒ…å—…æ¢å™¨"""
        self.interface = interface
        self.running = False
        self.callback: Optional[Callable] = None
    
    def set_callback(self, callback: Callable):
        """è¨­ç½®å›èª¿å‡½æ•¸"""
        self.callback = callback
    
    def packet_callback(self, packet):
        """æ•¸æ“šåŒ…å›èª¿å‡½æ•¸"""
        if self.callback:
            self.callback(packet)
    
    def start(self):
        """é–‹å§‹å—…æ¢"""
        self.running = True
        
        try:
            # é–‹å§‹æ•ç²æ•¸æ“šåŒ…
            sniff(
                iface=self.interface,
                prn=self.packet_callback,
                store=0
            )
        except Exception as e:
            print(f"Error starting sniffer: {e}")
        finally:
            self.running = False
    
    def stop(self):
        """åœæ­¢å—…æ¢"""
        self.running = False

def analyze_packet(packet):
    """åˆ†ææ•¸æ“šåŒ…"""
    if IP in packet:
        print(f"\nIP Packet:")
        print(f"Source: {packet[IP].src}")
        print(f"Destination: {packet[IP].dst}")
        print(f"Protocol: {packet[IP].proto}")
        print(f"Length: {len(packet)}")
        
        if TCP in packet:
            print(f"TCP Ports: {packet[TCP].sport} -> {packet[TCP].dport}")
        elif UDP in packet:
            print(f"UDP Ports: {packet[UDP].sport} -> {packet[UDP].dport}")

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºå—…æ¢å™¨
    sniffer = PacketSniffer()
    
    # è¨­ç½®å›èª¿å‡½æ•¸
    sniffer.set_callback(analyze_packet)
    
    print("Starting packet capture...")
    print("Press Ctrl+C to stop")
    
    try:
        # é–‹å§‹å—…æ¢
        sniffer.start()
    except KeyboardInterrupt:
        print("\nStopping packet capture...")
        sniffer.stop()

if __name__ == '__main__':
    main()
```

### 2. ARPæ¬ºé¨™æª¢æ¸¬

```python
from scapy.all import *
from typing import Dict, List
import threading
import time

class ARPSpoofDetector:
    def __init__(self, interface: str = "eth0"):
        """åˆå§‹åŒ–ARPæ¬ºé¨™æª¢æ¸¬å™¨"""
        self.interface = interface
        self.running = False
        self.arp_table: Dict[str, str] = {}  # IP -> MAC
        self.suspicious_entries: List[Tuple[str, str, str]] = []  # (IP, MAC, Timestamp)
    
    def analyze_packet(self, packet):
        """åˆ†æARPæ•¸æ“šåŒ…"""
        if ARP in packet:
            # ç²å–ARPåŒ…ä¿¡æ¯
            src_ip = packet[ARP].psrc
            src_mac = packet[ARP].hwsrc
            
            # æª¢æŸ¥æ˜¯å¦ç‚ºARPè«‹æ±‚
            if packet[ARP].op == 1:
                print(f"\nARP Request:")
                print(f"Who has {packet[ARP].pdst}? Tell {src_ip}")
            
            # æª¢æŸ¥æ˜¯å¦ç‚ºARPéŸ¿æ‡‰
            elif packet[ARP].op == 2:
                print(f"\nARP Response:")
                print(f"{src_ip} is at {src_mac}")
                
                # æª¢æŸ¥ARPè¡¨
                if src_ip in self.arp_table:
                    if self.arp_table[src_ip] != src_mac:
                        print(f"WARNING: ARP spoofing detected!")
                        print(f"IP: {src_ip}")
                        print(f"Old MAC: {self.arp_table[src_ip]}")
                        print(f"New MAC: {src_mac}")
                        
                        # è¨˜éŒ„å¯ç–‘é …
                        self.suspicious_entries.append((
                            src_ip,
                            src_mac,
                            time.strftime("%Y-%m-%d %H:%M:%S")
                        ))
                
                # æ›´æ–°ARPè¡¨
                self.arp_table[src_ip] = src_mac
    
    def start(self):
        """é–‹å§‹æª¢æ¸¬"""
        self.running = True
        
        try:
            # é–‹å§‹æ•ç²ARPæ•¸æ“šåŒ…
            sniff(
                iface=self.interface,
                filter="arp",
                prn=self.analyze_packet,
                store=0
            )
        except Exception as e:
            print(f"Error starting detector: {e}")
        finally:
            self.running = False
    
    def stop(self):
        """åœæ­¢æª¢æ¸¬"""
        self.running = False
    
    def get_suspicious_entries(self) -> List[Tuple[str, str, str]]:
        """ç²å–å¯ç–‘é …åˆ—è¡¨"""
        return self.suspicious_entries

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºæª¢æ¸¬å™¨
    detector = ARPSpoofDetector()
    
    print("Starting ARP spoofing detection...")
    print("Press Ctrl+C to stop")
    
    try:
        # é–‹å§‹æª¢æ¸¬
        detector.start()
    except KeyboardInterrupt:
        print("\nStopping detection...")
        detector.stop()
        
        # è¼¸å‡ºå¯ç–‘é …
        suspicious = detector.get_suspicious_entries()
        if suspicious:
            print("\nSuspicious ARP entries:")
            for ip, mac, timestamp in suspicious:
                print(f"IP: {ip}")
                print(f"MAC: {mac}")
                print(f"Time: {timestamp}")
                print()

if __name__ == '__main__':
    main()
```

## ç·´ç¿’é¡Œ

1. **ç¶²çµ¡æƒæå·¥å…·**
   é–‹ç™¼ä¸€å€‹ç¶²çµ¡æƒæå·¥å…·ï¼š
   - æ”¯æŒTCPå’ŒUDPæƒæ
   - å¯¦ç¾æœå‹™è­˜åˆ¥
   - æ·»åŠ æƒæé€²åº¦é¡¯ç¤º
   - ç”Ÿæˆæƒæå ±å‘Š

2. **ç¶²çµ¡ç›£æ§ç³»çµ±**
   å‰µå»ºä¸€å€‹ç¶²çµ¡ç›£æ§ç³»çµ±ï¼š
   - æ•ç²ç¶²çµ¡æµé‡
   - åˆ†æå”è­°ä½¿ç”¨
   - æª¢æ¸¬ç•°å¸¸æµé‡
   - ç”Ÿæˆçµ±è¨ˆå ±å‘Š

3. **å®‰å…¨æª¢æ¸¬å·¥å…·**
   å¯¦ç¾ä¸€å€‹å®‰å…¨æª¢æ¸¬å·¥å…·ï¼š
   - æª¢æ¸¬ARPæ¬ºé¨™
   - è­˜åˆ¥ç«¯å£æƒæ
   - ç›£æ§DNSæŸ¥è©¢
   - åˆ†æç¶²çµ¡è¡Œç‚º

## å°æé†’ ğŸ’¡

1. å®‰å…¨è€ƒæ…®
   - éµå®ˆæ³•å¾‹æ³•è¦
   - ä¿è­·ç”¨æˆ¶éš±ç§
   - é¿å…ç¶²çµ¡å¹²æ“¾
   - å®‰å…¨å­˜å„²æ•¸æ“š

2. æ€§èƒ½å„ªåŒ–
   - ä½¿ç”¨å¤šç·šç¨‹
   - å„ªåŒ–æ•¸æ“šè™•ç†
   - æ§åˆ¶è³‡æºä½¿ç”¨
   - å®šæœŸæ¸…ç†ç·©å­˜

3. å¯é æ€§
   - è™•ç†ç•°å¸¸æƒ…æ³
   - å¯¦ç¾éŒ¯èª¤æ¢å¾©
   - è¨˜éŒ„è©³ç´°æ—¥èªŒ
   - å®šæœŸå‚™ä»½æ•¸æ“š

4. èª¿è©¦æŠ€å·§
   - ä½¿ç”¨æŠ“åŒ…å·¥å…·
   - åˆ†æç¶²çµ¡æµé‡
   - æ¨¡æ“¬æ”»æ“Šå ´æ™¯
   - å£“åŠ›æ¸¬è©¦

[ä¸Šä¸€ç« ï¼šç¶²çµ¡å®‰å…¨é€²éš](071_ç¶²çµ¡å®‰å…¨é€²éš.md) | [ä¸‹ä¸€ç« ï¼šç¶²çµ¡æ”»é˜²é€²éš](073_ç¶²çµ¡æ”»é˜²é€²éš.md) 