[ä¸Šä¸€ç« ï¼šç¶²çµ¡ç·¨ç¨‹åŸºç¤](108_ç¶²çµ¡ç·¨ç¨‹åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šæ•¸æ“šåº«åŸºç¤](110_æ•¸æ“šåº«åŸºç¤.md)

# Python ç¶²çµ¡ç·¨ç¨‹é€²éš ğŸŒ

## ç¶²çµ¡ç·¨ç¨‹é€²éš

### 1. ç¶²çµ¡å®‰å…¨

```python
import socket
import sys
import os
from typing import Tuple, List, Optional, Dict
import time
import json
import ssl
import hashlib
import hmac
import base64

class SecureClient:
    def __init__(self, host: str = 'localhost', port: int = 5000, 
                 cert_file: str = None, key_file: str = None):
        """åˆå§‹åŒ–å®‰å…¨å®¢æˆ¶ç«¯"""
        try:
            # å‰µå»ºå¥—æ¥å­—
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            
            # è¨­ç½®åœ°å€
            self.host = host
            self.port = port
            
            # è¨­ç½®SSL
            if cert_file and key_file:
                self.context = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)
                self.context.load_cert_chain(cert_file, key_file)
                self.context.check_hostname = True
                self.context.verify_mode = ssl.CERT_REQUIRED
            else:
                self.context = None
            
            print(f"Secure client initialized: {host}:{port}")
            
        except Exception as e:
            print(f"Error initializing secure client: {e}")
    
    def connect(self) -> bool:
        """é€£æ¥åˆ°æœå‹™å™¨"""
        try:
            if self.context:
                self.socket = self.context.wrap_socket(self.socket, server_hostname=self.host)
            
            self.socket.connect((self.host, self.port))
            print(f"Connected to {self.host}:{self.port}")
            return True
            
        except Exception as e:
            print(f"Error connecting to server: {e}")
            return False
    
    def send_secure_data(self, data: Dict, secret_key: str) -> bool:
        """ç™¼é€å®‰å…¨æ•¸æ“š"""
        try:
            # å°‡æ•¸æ“šè½‰æ›ç‚ºJSONå­—ç¬¦ä¸²
            message = json.dumps(data)
            
            # è¨ˆç®—HMAC
            hmac_obj = hmac.new(secret_key.encode(), message.encode(), hashlib.sha256)
            signature = base64.b64encode(hmac_obj.digest()).decode()
            
            # æ§‹å»ºå®‰å…¨æ¶ˆæ¯
            secure_message = {
                "data": message,
                "signature": signature
            }
            
            # ç™¼é€å®‰å…¨æ¶ˆæ¯
            self.socket.send(json.dumps(secure_message).encode())
            print(f"Secure data sent: {data}")
            return True
            
        except Exception as e:
            print(f"Error sending secure data: {e}")
            return False
    
    def receive_secure_data(self, secret_key: str) -> Optional[Dict]:
        """æ¥æ”¶å®‰å…¨æ•¸æ“š"""
        try:
            # æ¥æ”¶æ•¸æ“š
            data = self.socket.recv(1024).decode()
            
            # è§£æJSONæ•¸æ“š
            if data:
                secure_message = json.loads(data)
                message = secure_message["data"]
                signature = secure_message["signature"]
                
                # é©—è­‰ç°½å
                hmac_obj = hmac.new(secret_key.encode(), message.encode(), hashlib.sha256)
                expected_signature = base64.b64encode(hmac_obj.digest()).decode()
                
                if signature == expected_signature:
                    return json.loads(message)
                else:
                    print("Invalid signature")
                    return None
            
            return None
            
        except Exception as e:
            print(f"Error receiving secure data: {e}")
            return None
    
    def close(self):
        """é—œé–‰é€£æ¥"""
        try:
            self.socket.close()
            print("Connection closed")
            
        except Exception as e:
            print(f"Error closing connection: {e}")

class SecureServer:
    def __init__(self, host: str = 'localhost', port: int = 5000,
                 cert_file: str = None, key_file: str = None):
        """åˆå§‹åŒ–å®‰å…¨æœå‹™å™¨"""
        try:
            # å‰µå»ºå¥—æ¥å­—
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            
            # è¨­ç½®åœ°å€
            self.host = host
            self.port = port
            
            # è¨­ç½®SSL
            if cert_file and key_file:
                self.context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)
                self.context.load_cert_chain(cert_file, key_file)
                self.context.check_hostname = True
                self.context.verify_mode = ssl.CERT_REQUIRED
            else:
                self.context = None
            
            # ç¶å®šåœ°å€
            self.socket.bind((host, port))
            
            # é–‹å§‹ç›£è½
            self.socket.listen(5)
            
            print(f"Secure server initialized: {host}:{port}")
            
        except Exception as e:
            print(f"Error initializing secure server: {e}")
    
    def accept_connection(self) -> Optional[socket.socket]:
        """æ¥å—é€£æ¥"""
        try:
            client_socket, address = self.socket.accept()
            
            if self.context:
                client_socket = self.context.wrap_socket(client_socket, server_side=True)
            
            print(f"Connection accepted from {address}")
            return client_socket
            
        except Exception as e:
            print(f"Error accepting connection: {e}")
            return None
    
    def send_secure_data(self, client_socket: socket.socket, data: Dict, secret_key: str) -> bool:
        """ç™¼é€å®‰å…¨æ•¸æ“š"""
        try:
            # å°‡æ•¸æ“šè½‰æ›ç‚ºJSONå­—ç¬¦ä¸²
            message = json.dumps(data)
            
            # è¨ˆç®—HMAC
            hmac_obj = hmac.new(secret_key.encode(), message.encode(), hashlib.sha256)
            signature = base64.b64encode(hmac_obj.digest()).decode()
            
            # æ§‹å»ºå®‰å…¨æ¶ˆæ¯
            secure_message = {
                "data": message,
                "signature": signature
            }
            
            # ç™¼é€å®‰å…¨æ¶ˆæ¯
            client_socket.send(json.dumps(secure_message).encode())
            print(f"Secure data sent: {data}")
            return True
            
        except Exception as e:
            print(f"Error sending secure data: {e}")
            return False
    
    def receive_secure_data(self, client_socket: socket.socket, secret_key: str) -> Optional[Dict]:
        """æ¥æ”¶å®‰å…¨æ•¸æ“š"""
        try:
            # æ¥æ”¶æ•¸æ“š
            data = client_socket.recv(1024).decode()
            
            # è§£æJSONæ•¸æ“š
            if data:
                secure_message = json.loads(data)
                message = secure_message["data"]
                signature = secure_message["signature"]
                
                # é©—è­‰ç°½å
                hmac_obj = hmac.new(secret_key.encode(), message.encode(), hashlib.sha256)
                expected_signature = base64.b64encode(hmac_obj.digest()).decode()
                
                if signature == expected_signature:
                    return json.loads(message)
                else:
                    print("Invalid signature")
                    return None
            
            return None
            
        except Exception as e:
            print(f"Error receiving secure data: {e}")
            return None
    
    def close(self):
        """é—œé–‰æœå‹™å™¨"""
        try:
            self.socket.close()
            print("Server closed")
            
        except Exception as e:
            print(f"Error closing server: {e}")

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºæœå‹™å™¨
    server = SecureServer()
    
    try:
        # æ¥å—é€£æ¥
        client_socket = server.accept_connection()
        if client_socket:
            # è¨­ç½®å¯†é‘°
            secret_key = "your_secret_key"
            
            # æ¥æ”¶å®‰å…¨æ•¸æ“š
            data = server.receive_secure_data(client_socket, secret_key)
            if data:
                print(f"Received secure data: {data}")
                
                # ç™¼é€å®‰å…¨éŸ¿æ‡‰
                response = {"status": "success", "message": "Secure data received"}
                server.send_secure_data(client_socket, response, secret_key)
            
            # é—œé–‰å®¢æˆ¶ç«¯é€£æ¥
            client_socket.close()
        
        # é—œé–‰æœå‹™å™¨
        server.close()
    
    except Exception as e:
        print(f"Error in main: {e}")

if __name__ == '__main__':
    main()
```

### 2. ç¶²çµ¡å„ªåŒ–

```python
import socket
import sys
import os
from typing import Tuple, List, Optional, Dict
import time
import json
import threading
import queue
import select

class OptimizedClient:
    def __init__(self, host: str = 'localhost', port: int = 5000):
        """åˆå§‹åŒ–å„ªåŒ–å®¢æˆ¶ç«¯"""
        try:
            # å‰µå»ºå¥—æ¥å­—
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            
            # è¨­ç½®åœ°å€
            self.host = host
            self.port = port
            
            # è¨­ç½®éé˜»å¡æ¨¡å¼
            self.socket.setblocking(False)
            
            # å‰µå»ºæ¶ˆæ¯éšŠåˆ—
            self.send_queue = queue.Queue()
            self.receive_queue = queue.Queue()
            
            # å‰µå»ºç·šç¨‹
            self.send_thread = None
            self.receive_thread = None
            
            print(f"Optimized client initialized: {host}:{port}")
            
        except Exception as e:
            print(f"Error initializing optimized client: {e}")
    
    def connect(self) -> bool:
        """é€£æ¥åˆ°æœå‹™å™¨"""
        try:
            self.socket.connect((self.host, self.port))
            print(f"Connected to {self.host}:{self.port}")
            
            # å•Ÿå‹•ç·šç¨‹
            self.send_thread = threading.Thread(target=self._send_loop)
            self.receive_thread = threading.Thread(target=self._receive_loop)
            self.send_thread.start()
            self.receive_thread.start()
            
            return True
            
        except Exception as e:
            print(f"Error connecting to server: {e}")
            return False
    
    def send_data(self, data: Dict):
        """ç™¼é€æ•¸æ“š"""
        try:
            self.send_queue.put(data)
            print(f"Data queued for sending: {data}")
            
        except Exception as e:
            print(f"Error queuing data: {e}")
    
    def receive_data(self) -> Optional[Dict]:
        """æ¥æ”¶æ•¸æ“š"""
        try:
            if not self.receive_queue.empty():
                return self.receive_queue.get()
            return None
            
        except Exception as e:
            print(f"Error receiving data: {e}")
            return None
    
    def _send_loop(self):
        """ç™¼é€å¾ªç’°"""
        try:
            while True:
                # å¾éšŠåˆ—ç²å–æ•¸æ“š
                data = self.send_queue.get()
                
                # å°‡æ•¸æ“šè½‰æ›ç‚ºJSONå­—ç¬¦ä¸²
                message = json.dumps(data)
                
                # ç™¼é€æ•¸æ“š
                self.socket.send(message.encode())
                print(f"Data sent: {data}")
                
        except Exception as e:
            print(f"Error in send loop: {e}")
    
    def _receive_loop(self):
        """æ¥æ”¶å¾ªç’°"""
        try:
            while True:
                # ä½¿ç”¨selectç›£è½å¥—æ¥å­—
                readable, _, _ = select.select([self.socket], [], [], 0.1)
                
                if readable:
                    # æ¥æ”¶æ•¸æ“š
                    data = self.socket.recv(1024).decode()
                    
                    # è§£æJSONæ•¸æ“š
                    if data:
                        self.receive_queue.put(json.loads(data))
                        print(f"Data received: {data}")
                
        except Exception as e:
            print(f"Error in receive loop: {e}")
    
    def close(self):
        """é—œé–‰é€£æ¥"""
        try:
            # åœæ­¢ç·šç¨‹
            if self.send_thread:
                self.send_thread.join()
            if self.receive_thread:
                self.receive_thread.join()
            
            # é—œé–‰å¥—æ¥å­—
            self.socket.close()
            print("Connection closed")
            
        except Exception as e:
            print(f"Error closing connection: {e}")

class OptimizedServer:
    def __init__(self, host: str = 'localhost', port: int = 5000):
        """åˆå§‹åŒ–å„ªåŒ–æœå‹™å™¨"""
        try:
            # å‰µå»ºå¥—æ¥å­—
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            
            # è¨­ç½®åœ°å€
            self.host = host
            self.port = port
            
            # è¨­ç½®éé˜»å¡æ¨¡å¼
            self.socket.setblocking(False)
            
            # ç¶å®šåœ°å€
            self.socket.bind((host, port))
            
            # é–‹å§‹ç›£è½
            self.socket.listen(5)
            
            # å‰µå»ºå®¢æˆ¶ç«¯å­—å…¸
            self.clients = {}
            
            print(f"Optimized server initialized: {host}:{port}")
            
        except Exception as e:
            print(f"Error initializing optimized server: {e}")
    
    def run(self):
        """é‹è¡Œæœå‹™å™¨"""
        try:
            while True:
                # ä½¿ç”¨selectç›£è½å¥—æ¥å­—
                readable, writable, exceptional = select.select(
                    [self.socket] + list(self.clients.keys()),
                    [],
                    [self.socket] + list(self.clients.keys()),
                    0.1
                )
                
                # è™•ç†å¯è®€å¥—æ¥å­—
                for sock in readable:
                    if sock is self.socket:
                        # æ¥å—æ–°é€£æ¥
                        client_socket, address = sock.accept()
                        client_socket.setblocking(False)
                        self.clients[client_socket] = address
                        print(f"Connection accepted from {address}")
                    else:
                        # æ¥æ”¶æ•¸æ“š
                        data = sock.recv(1024).decode()
                        if data:
                            print(f"Data received from {self.clients[sock]}: {data}")
                            
                            # ç™¼é€éŸ¿æ‡‰
                            response = {"status": "success", "message": "Data received"}
                            sock.send(json.dumps(response).encode())
                        else:
                            # å®¢æˆ¶ç«¯æ–·é–‹é€£æ¥
                            print(f"Connection closed by {self.clients[sock]}")
                            del self.clients[sock]
                            sock.close()
                
                # è™•ç†ç•°å¸¸å¥—æ¥å­—
                for sock in exceptional:
                    if sock is self.socket:
                        print("Server socket error")
                        return
                    else:
                        print(f"Client socket error: {self.clients[sock]}")
                        del self.clients[sock]
                        sock.close()
            
        except Exception as e:
            print(f"Error in server loop: {e}")
    
    def close(self):
        """é—œé–‰æœå‹™å™¨"""
        try:
            # é—œé–‰æ‰€æœ‰å®¢æˆ¶ç«¯é€£æ¥
            for client_socket in self.clients:
                client_socket.close()
            
            # æ¸…ç©ºå®¢æˆ¶ç«¯å­—å…¸
            self.clients.clear()
            
            # é—œé–‰æœå‹™å™¨å¥—æ¥å­—
            self.socket.close()
            print("Server closed")
            
        except Exception as e:
            print(f"Error closing server: {e}")

# ä½¿ç”¨ç¤ºä¾‹
def main():
    # å‰µå»ºæœå‹™å™¨
    server = OptimizedServer()
    
    try:
        # é‹è¡Œæœå‹™å™¨
        server.run()
    
    except KeyboardInterrupt:
        print("\nServer stopped by user")
    except Exception as e:
        print(f"Error in main: {e}")
    finally:
        # é—œé–‰æœå‹™å™¨
        server.close()

if __name__ == '__main__':
    main()
```

## ç·´ç¿’é¡Œ

1. **ç¶²çµ¡å®‰å…¨**
   é–‹ç™¼ç¶²çµ¡å®‰å…¨ï¼š
   - SSL/TLS
   - æ•¸æ“šåŠ å¯†
   - èº«ä»½é©—è­‰
   - å„ªåŒ–æ€§èƒ½

2. **ç¶²çµ¡å„ªåŒ–**
   å‰µå»ºç¶²çµ¡å„ªåŒ–ï¼š
   - éé˜»å¡IO
   - å¤šç·šç¨‹
   - é€£æ¥æ± 
   - å„ªåŒ–æ€§èƒ½

3. **ç¶²çµ¡ç·¨ç¨‹**
   å¯¦ç¾ç¶²çµ¡ç·¨ç¨‹ï¼š
   - å®‰å…¨ç³»çµ±
   - å„ªåŒ–ç³»çµ±
   - å„ªåŒ–æ€§èƒ½
   - è™•ç†ç•°å¸¸

## å°æé†’ ğŸ’¡

1. ç¶²çµ¡å®‰å…¨
   - é¸æ“‡åˆé©æ–¹æ³•
   - å„ªåŒ–åƒæ•¸
   - è™•ç†ç•°å¸¸
   - æä¾›ç›£æ§

2. ç¶²çµ¡å„ªåŒ–
   - é¸æ“‡åˆé©æ–¹æ³•
   - å„ªåŒ–æ€§èƒ½
   - è™•ç†ç•°å¸¸
   - æä¾›çµæœ

3. ç¶²çµ¡ç·¨ç¨‹
   - é¸æ“‡åˆé©ç®—æ³•
   - å„ªåŒ–æ€§èƒ½
   - è™•ç†ç•°å¸¸
   - æä¾›ç›£æ§

4. èª¿è©¦æŠ€å·§
   - ä½¿ç”¨é–‹ç™¼å·¥å…·
   - åˆ†ææ€§èƒ½
   - å„ªåŒ–é—œéµè·¯å¾‘
   - ç›£æ§è™•ç†ç‹€æ…‹

[ä¸Šä¸€ç« ï¼šç¶²çµ¡ç·¨ç¨‹åŸºç¤](108_ç¶²çµ¡ç·¨ç¨‹åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šæ•¸æ“šåº«åŸºç¤](110_æ•¸æ“šåº«åŸºç¤.md) 