[ä¸Šä¸€ç« ï¼šæ•¸æ“šåº«åŸºç¤](110_æ•¸æ“šåº«åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šæ•¸æ“šåº«å„ªåŒ–](112_æ•¸æ“šåº«å„ªåŒ–.md)

# Python æ•¸æ“šåº«é€²éš ğŸ¯

## 1. æ•¸æ“šåº«é€£æ¥æ± 

### 1.1 ä½¿ç”¨é€£æ¥æ± å„ªåŒ–æ€§èƒ½

```python
from dbutils.pooled_db import PooledDB
import mysql.connector
from typing import Dict, List, Optional

class DatabasePool:
    def __init__(self, host: str = "localhost", user: str = "root",
                 password: str = "", database: str = "test"):
        """åˆå§‹åŒ–æ•¸æ“šåº«é€£æ¥æ± """
        self.pool = PooledDB(
            creator=mysql.connector,  # ä½¿ç”¨mysql.connector
            maxconnections=6,         # é€£æ¥æ± å…è¨±çš„æœ€å¤§é€£æ¥æ•¸
            mincached=2,             # åˆå§‹åŒ–æ™‚ï¼Œé€£æ¥æ± ä¸­è‡³å°‘å‰µå»ºçš„ç©ºé–’çš„é€£æ¥
            maxcached=5,             # é€£æ¥æ± ä¸­æœ€å¤šé–’ç½®çš„é€£æ¥
            maxshared=3,             # é€£æ¥æ± ä¸­æœ€å¤šå…±äº«çš„é€£æ¥æ•¸é‡
            blocking=True,           # é€£æ¥æ± ä¸­å¦‚æœæ²’æœ‰å¯ç”¨é€£æ¥å¾Œï¼Œæ˜¯å¦é˜»å¡ç­‰å¾…
            maxusage=None,           # ä¸€å€‹é€£æ¥æœ€å¤šè¢«é‡è¤‡ä½¿ç”¨çš„æ¬¡æ•¸
            setsession=[],           # é–‹å§‹æœƒè©±å‰åŸ·è¡Œçš„å‘½ä»¤åˆ—è¡¨
            host=host,
            user=user,
            password=password,
            database=database
        )

    def get_connection(self):
        """ç²å–æ•¸æ“šåº«é€£æ¥"""
        return self.pool.connection()

    def execute_query(self, sql: str, params: tuple = None) -> List[Dict]:
        """åŸ·è¡ŒæŸ¥è©¢"""
        with self.get_connection() as conn:
            cursor = conn.cursor(dictionary=True)
            cursor.execute(sql, params or ())
            return cursor.fetchall()
```

## 2. äº‹å‹™ç®¡ç†

### 2.1 äº‹å‹™çš„ ACID ç‰¹æ€§

- **åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šäº‹å‹™ä¸­çš„æ‰€æœ‰æ“ä½œè¦éº¼å…¨éƒ¨å®Œæˆï¼Œè¦éº¼å…¨éƒ¨ä¸å®Œæˆ
- **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šäº‹å‹™å¿…é ˆä½¿æ•¸æ“šåº«å¾ä¸€å€‹ä¸€è‡´æ€§ç‹€æ…‹è®Šæ›åˆ°å¦ä¸€å€‹ä¸€è‡´æ€§ç‹€æ…‹
- **éš”é›¢æ€§ï¼ˆIsolationï¼‰**ï¼šä¸€å€‹äº‹å‹™çš„åŸ·è¡Œä¸èƒ½è¢«å…¶ä»–äº‹å‹™å¹²æ“¾
- **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šä¸€å€‹äº‹å‹™ä¸€æ—¦æäº¤ï¼Œå®ƒå°æ•¸æ“šåº«çš„æ”¹è®Šå°±æ˜¯æ°¸ä¹…æ€§çš„

### 2.2 äº‹å‹™ç®¡ç†ç¤ºä¾‹

```python
class TransactionManager:
    def __init__(self, db_pool: DatabasePool):
        self.db_pool = db_pool

    def execute_transaction(self, operations: List[Dict]):
        """åŸ·è¡Œäº‹å‹™"""
        connection = self.db_pool.get_connection()
        cursor = connection.cursor(dictionary=True)
        
        try:
            # é–‹å§‹äº‹å‹™
            connection.start_transaction()
            
            # åŸ·è¡Œæ‰€æœ‰æ“ä½œ
            for operation in operations:
                cursor.execute(operation['sql'], operation.get('params', ()))
            
            # æäº¤äº‹å‹™
            connection.commit()
            return True
            
        except Exception as e:
            # ç™¼ç”ŸéŒ¯èª¤æ™‚å›æ»¾
            connection.rollback()
            print(f"Transaction failed: {e}")
            return False
            
        finally:
            cursor.close()
            connection.close()
```

## 3. ORMï¼ˆå°è±¡é—œä¿‚æ˜ å°„ï¼‰

### 3.1 ä½¿ç”¨ SQLAlchemy

```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    
    id = Column(Integer, primary_key=True)
    name = Column(String(50))
    email = Column(String(120), unique=True)
    
    def __repr__(self):
        return f"<User(name='{self.name}', email='{self.email}')>"

class SQLAlchemyManager:
    def __init__(self, connection_string: str):
        self.engine = create_engine(connection_string)
        Base.metadata.create_all(self.engine)
        Session = sessionmaker(bind=self.engine)
        self.session = Session()

    def add_user(self, name: str, email: str):
        """æ·»åŠ ç”¨æˆ¶"""
        user = User(name=name, email=email)
        self.session.add(user)
        self.session.commit()
        return user

    def get_user(self, user_id: int):
        """ç²å–ç”¨æˆ¶"""
        return self.session.query(User).filter_by(id=user_id).first()
```

## 4. æ•¸æ“šåº«å®‰å…¨æ€§

### 4.1 é˜²æ­¢ SQL æ³¨å…¥

```python
class SecureDatabase:
    def __init__(self, db_pool: DatabasePool):
        self.db_pool = db_pool

    def safe_query(self, sql: str, params: tuple):
        """å®‰å…¨çš„æŸ¥è©¢æ–¹æ³•"""
        return self.db_pool.execute_query(sql, params)

    def unsafe_example(self, user_input: str):
        """ä¸å®‰å…¨çš„ç¤ºä¾‹ï¼ˆä¸è¦ä½¿ç”¨ï¼‰"""
        sql = f"SELECT * FROM users WHERE name = '{user_input}'"  # å±éšªï¼
        return self.db_pool.execute_query(sql)

    def safe_example(self, user_input: str):
        """å®‰å…¨çš„ç¤ºä¾‹ï¼ˆæ¨è–¦ä½¿ç”¨ï¼‰"""
        sql = "SELECT * FROM users WHERE name = %s"
        return self.db_pool.execute_query(sql, (user_input,))
```

### 4.2 å¯†ç¢¼åŠ å¯†å­˜å„²

```python
import hashlib
import os

class PasswordManager:
    @staticmethod
    def hash_password(password: str) -> tuple:
        """å°å¯†ç¢¼é€²è¡ŒåŠ é¹½å“ˆå¸Œ"""
        salt = os.urandom(32)
        key = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt,
            100000
        )
        return salt, key

    @staticmethod
    def verify_password(stored_salt: bytes, stored_key: bytes, password: str) -> bool:
        """é©—è­‰å¯†ç¢¼"""
        new_key = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            stored_salt,
            100000
        )
        return new_key == stored_key
```

## 5. æ•¸æ“šåº«ç›£æ§èˆ‡æ—¥èªŒ

### 5.1 æ•¸æ“šåº«æ“ä½œæ—¥èªŒ

```python
import logging
from datetime import datetime

class DatabaseLogger:
    def __init__(self, log_file: str = "database.log"):
        logging.basicConfig(
            filename=log_file,
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s'
        )
        self.logger = logging

    def log_query(self, query: str, params: tuple = None):
        """è¨˜éŒ„æŸ¥è©¢"""
        self.logger.info(f"Query: {query}, Params: {params}")

    def log_error(self, error: Exception, query: str = None):
        """è¨˜éŒ„éŒ¯èª¤"""
        self.logger.error(f"Error: {error}, Query: {query}")

    def log_performance(self, query: str, execution_time: float):
        """è¨˜éŒ„æ€§èƒ½"""
        self.logger.info(f"Query: {query}, Execution time: {execution_time:.2f}s")
```

## ç·´ç¿’é¡Œ ğŸƒ

1. å¯¦ç¾ä¸€å€‹ä½¿ç”¨é€£æ¥æ± çš„æ•¸æ“šåº«æ“ä½œé¡ï¼Œä¸¦æ¸¬è©¦å…¶æ€§èƒ½ã€‚
2. ç·¨å¯«ä¸€å€‹å®Œæ•´çš„äº‹å‹™ç®¡ç†ç¤ºä¾‹ï¼ŒåŒ…å«è½‰è³¬ç­‰æ“ä½œã€‚
3. ä½¿ç”¨ SQLAlchemy å‰µå»ºä¸€å€‹ç°¡å–®çš„åšå®¢ç³»çµ±çš„æ•¸æ“šæ¨¡å‹ã€‚
4. å¯¦ç¾ä¸€å€‹å®‰å…¨çš„ç”¨æˆ¶èªè­‰ç³»çµ±ï¼ŒåŒ…å«å¯†ç¢¼åŠ å¯†å­˜å„²ã€‚
5. è¨­è¨ˆä¸€å€‹æ•¸æ“šåº«ç›£æ§ç³»çµ±ï¼Œè¨˜éŒ„æŸ¥è©¢æ€§èƒ½å’ŒéŒ¯èª¤ä¿¡æ¯ã€‚

## å°çµ ğŸ“

- å­¸ç¿’äº†æ•¸æ“šåº«é€£æ¥æ± çš„ä½¿ç”¨å’Œå„ªåŒ–
- ç†è§£äº†äº‹å‹™çš„ ACID ç‰¹æ€§å’Œç®¡ç†æ–¹æ³•
- æŒæ¡äº† ORM æ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•
- äº†è§£äº†æ•¸æ“šåº«å®‰å…¨æ€§çš„é‡è¦æ€§
- å­¸æœƒäº†å¦‚ä½•é€²è¡Œæ•¸æ“šåº«ç›£æ§å’Œæ—¥èªŒè¨˜éŒ„

## å»¶ä¼¸é–±è®€ ğŸ“š

1. SQLAlchemy å®˜æ–¹æ–‡æª”
2. MySQL äº‹å‹™éš”é›¢ç´šåˆ¥
3. æ•¸æ“šåº«å®‰å…¨æœ€ä½³å¯¦è¸
4. æ•¸æ“šåº«æ€§èƒ½å„ªåŒ–æŒ‡å—
5. Python æ•¸æ“šåº«é–‹ç™¼è¨­è¨ˆæ¨¡å¼ 