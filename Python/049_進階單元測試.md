[ä¸Šä¸€ç« ï¼šå–®å…ƒæ¸¬è©¦åŸºç¤](048_å–®å…ƒæ¸¬è©¦åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šå°ˆæ¡ˆå¯¦è¸](050_å°ˆæ¡ˆå¯¦è¸.md)

# Python é€²éšå–®å…ƒæ¸¬è©¦ ğŸ¯

## Mock å°è±¡

### 1. åŸºæœ¬ Mock ä½¿ç”¨

```python
from unittest.mock import Mock, patch
import unittest

class ExternalService:
    def get_data(self):
        # å‡è¨­é€™æ˜¯ä¸€å€‹å¤–éƒ¨æœå‹™èª¿ç”¨
        pass

class DataProcessor:
    def __init__(self, service):
        self.service = service
    
    def process_data(self):
        data = self.service.get_data()
        if data:
            return data.upper()
        return None

class TestDataProcessor(unittest.TestCase):
    def test_process_data(self):
        # å‰µå»º Mock å°è±¡
        mock_service = Mock()
        mock_service.get_data.return_value = "test data"
        
        # ä½¿ç”¨ Mock å°è±¡
        processor = DataProcessor(mock_service)
        result = processor.process_data()
        
        # é©—è­‰çµæœ
        self.assertEqual(result, "TEST DATA")
        mock_service.get_data.assert_called_once()
    
    def test_process_data_none(self):
        mock_service = Mock()
        mock_service.get_data.return_value = None
        
        processor = DataProcessor(mock_service)
        result = processor.process_data()
        
        self.assertIsNone(result)
        mock_service.get_data.assert_called_once()

    @patch('__main__.ExternalService')
    def test_process_data_with_patch(self, mock_service_class):
        # é…ç½® Mock
        mock_service_class.return_value.get_data.return_value = "patched data"
        
        # ä½¿ç”¨è¢« patch çš„æœå‹™
        service = ExternalService()
        processor = DataProcessor(service)
        result = processor.process_data()
        
        # é©—è­‰çµæœ
        self.assertEqual(result, "PATCHED DATA")
        mock_service_class.return_value.get_data.assert_called_once()
```

### 2. Mock é€²éšç‰¹æ€§

```python
from unittest.mock import Mock, call, patch
import unittest

class APIClient:
    def __init__(self, base_url):
        self.base_url = base_url
    
    def get_user(self, user_id):
        # å‡è¨­é€™æ˜¯ä¸€å€‹ API èª¿ç”¨
        pass
    
    def update_user(self, user_id, data):
        # å‡è¨­é€™æ˜¯ä¸€å€‹ API èª¿ç”¨
        pass

class UserService:
    def __init__(self, api_client):
        self.api_client = api_client
    
    def process_user(self, user_id):
        user = self.api_client.get_user(user_id)
        if user:
            # è™•ç†ç”¨æˆ¶æ•¸æ“š
            processed_data = {"status": "processed"}
            self.api_client.update_user(user_id, processed_data)
            return True
        return False

class TestUserService(unittest.TestCase):
    def setUp(self):
        self.mock_client = Mock()
        self.service = UserService(self.mock_client)
    
    def test_process_user_success(self):
        # é…ç½® Mock çš„è¡Œç‚º
        self.mock_client.get_user.return_value = {"id": 1, "name": "Test"}
        
        # åŸ·è¡Œæ¸¬è©¦
        result = self.service.process_user(1)
        
        # é©—è­‰çµæœ
        self.assertTrue(result)
        
        # é©—è­‰æ–¹æ³•èª¿ç”¨
        expected_calls = [
            call.get_user(1),
            call.update_user(1, {"status": "processed"})
        ]
        self.mock_client.assert_has_calls(expected_calls)
    
    def test_process_user_not_found(self):
        # é…ç½® Mock è¿”å› None
        self.mock_client.get_user.return_value = None
        
        # åŸ·è¡Œæ¸¬è©¦
        result = self.service.process_user(1)
        
        # é©—è­‰çµæœ
        self.assertFalse(result)
        
        # é©—è­‰åªèª¿ç”¨äº† get_user
        self.mock_client.get_user.assert_called_once_with(1)
        self.mock_client.update_user.assert_not_called()
    
    def test_mock_side_effect(self):
        # ä½¿ç”¨ side_effect æ¨¡æ“¬ä¸åŒçš„è¿”å›å€¼
        self.mock_client.get_user.side_effect = [
            {"id": 1, "name": "User1"},
            {"id": 2, "name": "User2"},
            None
        ]
        
        # é€£çºŒèª¿ç”¨ä¸‰æ¬¡
        self.assertTrue(self.service.process_user(1))
        self.assertTrue(self.service.process_user(2))
        self.assertFalse(self.service.process_user(3))
    
    def test_mock_exception(self):
        # æ¨¡æ“¬ç•°å¸¸
        self.mock_client.get_user.side_effect = ConnectionError("API Error")
        
        # é©—è­‰ç•°å¸¸
        with self.assertRaises(ConnectionError):
            self.service.process_user(1)
```

## åƒæ•¸åŒ–æ¸¬è©¦

### 1. ä½¿ç”¨ parameterized

```python
from parameterized import parameterized
import unittest

def calculate_discount(amount, type_):
    if type_ == "vip":
        return amount * 0.8
    elif type_ == "regular":
        return amount * 0.9
    else:
        return amount

class TestDiscount(unittest.TestCase):
    @parameterized.expand([
        ("vip", 100, 80),
        ("regular", 100, 90),
        ("none", 100, 100),
        ("vip", 0, 0),
        ("regular", 50, 45),
    ])
    def test_calculate_discount(self, type_, amount, expected):
        result = calculate_discount(amount, type_)
        self.assertEqual(result, expected)
    
    @parameterized.expand([
        ("test1", [1, 2, 3], 6),
        ("test2", [0, 0, 0], 0),
        ("test3", [-1, 1, 0], 0),
        ("test4", [10], 10),
        ("test5", [], 0),
    ])
    def test_sum(self, name, input_list, expected):
        result = sum(input_list)
        self.assertEqual(result, expected)
```

### 2. ä½¿ç”¨ ddt

```python
from ddt import ddt, data, unpack
import unittest

def validate_password(password):
    if len(password) < 8:
        return False, "Password too short"
    if not any(c.isupper() for c in password):
        return False, "No uppercase letter"
    if not any(c.islower() for c in password):
        return False, "No lowercase letter"
    if not any(c.isdigit() for c in password):
        return False, "No number"
    return True, "Password is valid"

@ddt
class TestPasswordValidation(unittest.TestCase):
    @data(
        ("Abcd123!", True, "Password is valid"),
        ("abc123", False, "Password too short"),
        ("abcdefgh", False, "No uppercase letter"),
        ("ABCDEFGH", False, "No lowercase letter"),
        ("Abcdefgh", False, "No number"),
    )
    @unpack
    def test_password_validation(self, password, valid, message):
        result, msg = validate_password(password)
        self.assertEqual(result, valid)
        self.assertEqual(msg, message)
```

## æ¸¬è©¦è¦†è“‹ç‡

### 1. ä½¿ç”¨ coverage.py

```python
# ç¤ºä¾‹ä»£ç¢¼ï¼šmath_operations.py
def add(a, b):
    return a + b

def subtract(a, b):
    return a - b

def multiply(a, b):
    return a * b

def divide(a, b):
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b

def power(a, b):
    if b < 0:
        raise ValueError("Negative exponent not supported")
    return a ** b

# æ¸¬è©¦ä»£ç¢¼ï¼štest_math_operations.py
import unittest
from math_operations import *

class TestMathOperations(unittest.TestCase):
    def test_add(self):
        self.assertEqual(add(2, 3), 5)
        self.assertEqual(add(-1, 1), 0)
    
    def test_subtract(self):
        self.assertEqual(subtract(5, 3), 2)
        self.assertEqual(subtract(1, 1), 0)
    
    def test_multiply(self):
        self.assertEqual(multiply(2, 3), 6)
        self.assertEqual(multiply(-2, 3), -6)
    
    def test_divide(self):
        self.assertEqual(divide(6, 2), 3)
        self.assertEqual(divide(5, 2), 2.5)
        
        with self.assertRaises(ValueError):
            divide(5, 0)
    
    def test_power(self):
        self.assertEqual(power(2, 3), 8)
        self.assertEqual(power(2, 0), 1)
        
        with self.assertRaises(ValueError):
            power(2, -1)

# é‹è¡Œæ¸¬è©¦è¦†è“‹ç‡
# coverage run -m unittest test_math_operations.py
# coverage report
# coverage html
```

### 2. åˆ†æ”¯è¦†è“‹ç‡

```python
def process_age(age):
    if age < 0:
        raise ValueError("Age cannot be negative")
    elif age < 18:
        return "Minor"
    elif age < 65:
        return "Adult"
    else:
        return "Senior"

class TestAgeProcessing(unittest.TestCase):
    def test_process_age(self):
        # æ¸¬è©¦è² æ•¸å¹´é½¡
        with self.assertRaises(ValueError):
            process_age(-1)
        
        # æ¸¬è©¦æœªæˆå¹´
        self.assertEqual(process_age(15), "Minor")
        
        # æ¸¬è©¦æˆå¹´äºº
        self.assertEqual(process_age(30), "Adult")
        
        # æ¸¬è©¦è€å¹´äºº
        self.assertEqual(process_age(70), "Senior")
        
        # æ¸¬è©¦é‚Šç•Œå€¼
        self.assertEqual(process_age(0), "Minor")
        self.assertEqual(process_age(17), "Minor")
        self.assertEqual(process_age(18), "Adult")
        self.assertEqual(process_age(64), "Adult")
        self.assertEqual(process_age(65), "Senior")
```

## æ¸¬è©¦æ€§èƒ½å„ªåŒ–

### 1. ä½¿ç”¨ setUp å’Œ tearDown

```python
import unittest
import tempfile
import os
import time

class TestPerformance(unittest.TestCase):
    def setUp(self):
        # å‰µå»ºæ¸¬è©¦ç’°å¢ƒ
        self.test_dir = tempfile.mkdtemp()
        self.start_time = time.time()
    
    def tearDown(self):
        # æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
        if os.path.exists(self.test_dir):
            for file in os.listdir(self.test_dir):
                os.remove(os.path.join(self.test_dir, file))
            os.rmdir(self.test_dir)
        
        # è¼¸å‡ºæ¸¬è©¦åŸ·è¡Œæ™‚é–“
        elapsed = time.time() - self.start_time
        print(f"{self.id()}: {elapsed:.3f} seconds")
    
    def test_file_operations(self):
        # å‰µå»ºæ¸¬è©¦æ–‡ä»¶
        filename = os.path.join(self.test_dir, "test.txt")
        with open(filename, "w") as f:
            f.write("test content")
        
        # è®€å–æ–‡ä»¶
        with open(filename, "r") as f:
            content = f.read()
        
        self.assertEqual(content, "test content")
```

### 2. ä½¿ç”¨ setUpClass å’Œ tearDownClass

```python
import unittest
import sqlite3

class TestDatabase(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        # å‰µå»ºæ•¸æ“šåº«é€£æ¥
        cls.conn = sqlite3.connect(":memory:")
        cls.cursor = cls.conn.cursor()
        
        # å‰µå»ºæ¸¬è©¦è¡¨
        cls.cursor.execute("""
            CREATE TABLE users (
                id INTEGER PRIMARY KEY,
                name TEXT,
                age INTEGER
            )
        """)
    
    @classmethod
    def tearDownClass(cls):
        # é—œé–‰æ•¸æ“šåº«é€£æ¥
        cls.cursor.close()
        cls.conn.close()
    
    def setUp(self):
        # åœ¨æ¯å€‹æ¸¬è©¦ä¹‹å‰æ¸…ç©ºè¡¨
        self.cursor.execute("DELETE FROM users")
        self.conn.commit()
    
    def test_insert_user(self):
        # æ’å…¥æ¸¬è©¦æ•¸æ“š
        self.cursor.execute(
            "INSERT INTO users (name, age) VALUES (?, ?)",
            ("Test User", 25)
        )
        self.conn.commit()
        
        # é©—è­‰æ’å…¥
        self.cursor.execute("SELECT * FROM users")
        user = self.cursor.fetchone()
        self.assertEqual(user[1], "Test User")
        self.assertEqual(user[2], 25)
```

## å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### 1. Web API æ¸¬è©¦

```python
import unittest
from unittest.mock import patch
import requests

class APIClient:
    def __init__(self, base_url):
        self.base_url = base_url
    
    def get_user(self, user_id):
        response = requests.get(f"{self.base_url}/users/{user_id}")
        response.raise_for_status()
        return response.json()
    
    def create_user(self, data):
        response = requests.post(f"{self.base_url}/users", json=data)
        response.raise_for_status()
        return response.json()

class TestAPIClient(unittest.TestCase):
    def setUp(self):
        self.client = APIClient("https://api.example.com")
    
    @patch('requests.get')
    def test_get_user(self, mock_get):
        # é…ç½® mock éŸ¿æ‡‰
        mock_response = mock_get.return_value
        mock_response.json.return_value = {
            "id": 1,
            "name": "Test User",
            "email": "test@example.com"
        }
        
        # åŸ·è¡Œè«‹æ±‚
        user = self.client.get_user(1)
        
        # é©—è­‰çµæœ
        self.assertEqual(user["name"], "Test User")
        mock_get.assert_called_once_with(
            "https://api.example.com/users/1"
        )
    
    @patch('requests.post')
    def test_create_user(self, mock_post):
        # æ¸¬è©¦æ•¸æ“š
        user_data = {
            "name": "New User",
            "email": "new@example.com"
        }
        
        # é…ç½® mock éŸ¿æ‡‰
        mock_response = mock_post.return_value
        mock_response.json.return_value = {
            "id": 2,
            **user_data
        }
        
        # åŸ·è¡Œè«‹æ±‚
        result = self.client.create_user(user_data)
        
        # é©—è­‰çµæœ
        self.assertEqual(result["name"], "New User")
        mock_post.assert_called_once_with(
            "https://api.example.com/users",
            json=user_data
        )
```

### 2. æ•¸æ“šåº«æ“ä½œæ¸¬è©¦

```python
import unittest
import sqlite3
from contextlib import contextmanager

class DatabaseManager:
    def __init__(self, db_path):
        self.db_path = db_path
    
    @contextmanager
    def get_connection(self):
        conn = sqlite3.connect(self.db_path)
        try:
            yield conn
        finally:
            conn.close()
    
    def create_tables(self):
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS products (
                    id INTEGER PRIMARY KEY,
                    name TEXT NOT NULL,
                    price REAL NOT NULL
                )
            """)
            conn.commit()
    
    def add_product(self, name, price):
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute(
                "INSERT INTO products (name, price) VALUES (?, ?)",
                (name, price)
            )
            conn.commit()
            return cursor.lastrowid
    
    def get_product(self, product_id):
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute(
                "SELECT * FROM products WHERE id = ?",
                (product_id,)
            )
            return cursor.fetchone()
    
    def update_price(self, product_id, new_price):
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute(
                "UPDATE products SET price = ? WHERE id = ?",
                (new_price, product_id)
            )
            conn.commit()
            return cursor.rowcount > 0

class TestDatabaseManager(unittest.TestCase):
    def setUp(self):
        # ä½¿ç”¨å…§å­˜æ•¸æ“šåº«é€²è¡Œæ¸¬è©¦
        self.db = DatabaseManager(":memory:")
        self.db.create_tables()
    
    def test_add_product(self):
        # æ·»åŠ ç”¢å“
        product_id = self.db.add_product("Test Product", 99.99)
        
        # é©—è­‰ç”¢å“å·²æ·»åŠ 
        product = self.db.get_product(product_id)
        self.assertIsNotNone(product)
        self.assertEqual(product[1], "Test Product")
        self.assertEqual(product[2], 99.99)
    
    def test_update_price(self):
        # æ·»åŠ ç”¢å“
        product_id = self.db.add_product("Test Product", 99.99)
        
        # æ›´æ–°åƒ¹æ ¼
        success = self.db.update_price(product_id, 79.99)
        self.assertTrue(success)
        
        # é©—è­‰åƒ¹æ ¼å·²æ›´æ–°
        product = self.db.get_product(product_id)
        self.assertEqual(product[2], 79.99)
    
    def test_update_nonexistent_product(self):
        # å˜—è©¦æ›´æ–°ä¸å­˜åœ¨çš„ç”¢å“
        success = self.db.update_price(999, 79.99)
        self.assertFalse(success)
```

## ç·´ç¿’é¡Œ

1. **API å®¢æˆ¶ç«¯æ¸¬è©¦**
   å¯¦ç¾ä¸€å€‹ REST API å®¢æˆ¶ç«¯çš„å®Œæ•´æ¸¬è©¦å¥—ä»¶ï¼š
   - æ¸¬è©¦ä¸åŒçš„ HTTP æ–¹æ³•
   - æ¨¡æ“¬ä¸åŒçš„éŸ¿æ‡‰ç‹€æ…‹
   - è™•ç†éŒ¯èª¤æƒ…æ³
   - æ¸¬è©¦è«‹æ±‚åƒæ•¸é©—è­‰

2. **æ•¸æ“šåº«äº‹å‹™æ¸¬è©¦**
   ç‚ºæ•¸æ“šåº«æ“ä½œç·¨å¯«æ¸¬è©¦ç”¨ä¾‹ï¼š
   - æ¸¬è©¦äº‹å‹™å›æ»¾
   - æ¸¬è©¦ä¸¦ç™¼æ“ä½œ
   - æ¸¬è©¦æ•¸æ“šå®Œæ•´æ€§ç´„æŸ
   - ä½¿ç”¨æ¸¬è©¦æ›¿èº«

3. **æ€§èƒ½æ¸¬è©¦**
   å¯¦ç¾æ€§èƒ½æ¸¬è©¦ç”¨ä¾‹ï¼š
   - æ¸¬è©¦éŸ¿æ‡‰æ™‚é–“
   - æ¸¬è©¦è³‡æºä½¿ç”¨
   - æ¸¬è©¦ä¸¦ç™¼æ€§èƒ½
   - è¨­ç½®æ€§èƒ½åŸºæº–

## å°æé†’ ğŸ’¡

1. Mock ä½¿ç”¨
   - åª mock å¤–éƒ¨ä¾è³´
   - ä¿æŒ mock çš„ç°¡å–®æ€§
   - é©—è­‰ mock çš„èª¿ç”¨
   - æ³¨æ„ mock çš„ç¯„åœ

2. æ¸¬è©¦è¦†è“‹ç‡
   - é—œæ³¨é—œéµä»£ç¢¼è·¯å¾‘
   - ä¸éåˆ†è¿½æ±‚è¦†è“‹ç‡æ•¸å­—
   - å®šæœŸæª¢æŸ¥è¦†è“‹ç‡å ±å‘Š
   - å„ªå…ˆæ¸¬è©¦è¤‡é›œé‚è¼¯

3. æ€§èƒ½è€ƒæ…®
   - ä¿æŒæ¸¬è©¦åŸ·è¡Œé€Ÿåº¦
   - åˆç†ä½¿ç”¨æ¸¬è©¦å¤¾å…·
   - é¿å…ä¸å¿…è¦çš„è¨­ç½®
   - å„ªåŒ–æ¸¬è©¦æ•¸æ“š

4. æœ€ä½³å¯¦è¸
   - éµå¾ªæ¸¬è©¦é‡‘å­—å¡”
   - ä¿æŒæ¸¬è©¦çš„å¯ç¶­è­·æ€§
   - å®šæœŸé‡æ§‹æ¸¬è©¦ä»£ç¢¼
   - æ³¨æ„æ¸¬è©¦çš„å¯è®€æ€§

[ä¸Šä¸€ç« ï¼šå–®å…ƒæ¸¬è©¦åŸºç¤](048_å–®å…ƒæ¸¬è©¦åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šå°ˆæ¡ˆå¯¦è¸](050_å°ˆæ¡ˆå¯¦è¸.md) 