[ä¸Šä¸€ç« ï¼šç¶²çµ¡ç·¨ç¨‹åŸºç¤](086_ç¶²çµ¡ç·¨ç¨‹åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šæ•¸æ“šåº«ç·¨ç¨‹åŸºç¤](088_æ•¸æ“šåº«ç·¨ç¨‹åŸºç¤.md)

# Python ç¶²çµ¡ç·¨ç¨‹é€²éš ğŸŒ

## ç•°æ­¥ç¶²çµ¡ç·¨ç¨‹

### 1. ç•°æ­¥Socketæœå‹™å™¨

```python
import asyncio
import socket
import time
from typing import List, Dict, Any, Optional
import sys
import os

class AsyncSocketServer:
    def __init__(self, host: str = 'localhost', port: int = 5000):
        """åˆå§‹åŒ–ç•°æ­¥Socketæœå‹™å™¨"""
        self.host = host
        self.port = port
        self.clients: List[asyncio.StreamReader, asyncio.StreamWriter] = []
        self.is_running = False
    
    async def start(self):
        """å•Ÿå‹•æœå‹™å™¨"""
        try:
            # å‰µå»ºæœå‹™å™¨
            server = await asyncio.start_server(
                self._handle_client,
                self.host,
                self.port
            )
            self.is_running = True
            print(f"Server started on {self.host}:{self.port}")
            
            # ç­‰å¾…æœå‹™å™¨é—œé–‰
            async with server:
                await server.serve_forever()
            
        except Exception as e:
            print(f"Error starting server: {e}")
            await self.stop()
    
    async def stop(self):
        """åœæ­¢æœå‹™å™¨"""
        self.is_running = False
        for reader, writer in self.clients:
            try:
                writer.close()
                await writer.wait_closed()
            except:
                pass
    
    async def _handle_client(self, reader: asyncio.StreamReader, writer: asyncio.StreamWriter):
        """è™•ç†å®¢æˆ¶ç«¯é€£æ¥"""
        # ç²å–å®¢æˆ¶ç«¯åœ°å€
        addr = writer.get_extra_info('peername')
        print(f"New connection from {addr}")
        
        # æ·»åŠ å®¢æˆ¶ç«¯
        self.clients.append((reader, writer))
        
        try:
            while self.is_running:
                # æ¥æ”¶æ•¸æ“š
                data = await reader.read(1024)
                if not data:
                    break
                
                # è™•ç†æ•¸æ“š
                response = await self._process_data(data)
                
                # ç™¼é€éŸ¿æ‡‰
                writer.write(response)
                await writer.drain()
        
        except Exception as e:
            print(f"Error handling client {addr}: {e}")
        
        finally:
            # æ¸…ç†å®¢æˆ¶ç«¯é€£æ¥
            self.clients.remove((reader, writer))
            writer.close()
            await writer.wait_closed()
            print(f"Client {addr} disconnected")
    
    async def _process_data(self, data: bytes) -> bytes:
        """è™•ç†æ¥æ”¶åˆ°çš„æ•¸æ“š"""
        try:
            # è§£ç¢¼æ•¸æ“š
            message = data.decode('utf-8')
            print(f"Received: {message}")
            
            # è™•ç†æ¶ˆæ¯
            response = f"Server received: {message}"
            
            # ç·¨ç¢¼éŸ¿æ‡‰
            return response.encode('utf-8')
        
        except Exception as e:
            print(f"Error processing data: {e}")
            return b"Error processing data"
    
    async def broadcast(self, message: str):
        """å»£æ’­æ¶ˆæ¯çµ¦æ‰€æœ‰å®¢æˆ¶ç«¯"""
        data = message.encode('utf-8')
        for reader, writer in self.clients[:]:  # ä½¿ç”¨åˆ‡ç‰‡å‰µå»ºå‰¯æœ¬
            try:
                writer.write(data)
                await writer.drain()
            except:
                self.clients.remove((reader, writer))
                writer.close()
                await writer.wait_closed()

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    # å‰µå»ºæœå‹™å™¨
    server = AsyncSocketServer()
    
    try:
        # å•Ÿå‹•æœå‹™å™¨
        await server.start()
        
        # ç­‰å¾…ä¸€æ®µæ™‚é–“
        await asyncio.sleep(5)
        
        # å»£æ’­æ¶ˆæ¯
        await server.broadcast("Hello, clients!")
        
        # ç­‰å¾…ä¸€æ®µæ™‚é–“
        await asyncio.sleep(5)
    
    finally:
        # åœæ­¢æœå‹™å™¨
        await server.stop()

if __name__ == '__main__':
    asyncio.run(main())
```

### 2. ç•°æ­¥Socketå®¢æˆ¶ç«¯

```python
import asyncio
import time
from typing import Optional
import sys
import os

class AsyncSocketClient:
    def __init__(self, host: str = 'localhost', port: int = 5000):
        """åˆå§‹åŒ–ç•°æ­¥Socketå®¢æˆ¶ç«¯"""
        self.host = host
        self.port = port
        self.reader: Optional[asyncio.StreamReader] = None
        self.writer: Optional[asyncio.StreamWriter] = None
        self.is_connected = False
        self.is_running = False
    
    async def connect(self):
        """é€£æ¥åˆ°æœå‹™å™¨"""
        try:
            # å»ºç«‹é€£æ¥
            self.reader, self.writer = await asyncio.open_connection(
                self.host,
                self.port
            )
            self.is_connected = True
            self.is_running = True
            print(f"Connected to {self.host}:{self.port}")
            
            # å•Ÿå‹•æ¥æ”¶æ¶ˆæ¯çš„ä»»å‹™
            asyncio.create_task(self._receive_messages())
            
        except Exception as e:
            print(f"Error connecting to server: {e}")
            await self.disconnect()
    
    async def disconnect(self):
        """æ–·é–‹é€£æ¥"""
        self.is_running = False
        if self.writer:
            try:
                self.writer.close()
                await self.writer.wait_closed()
            except:
                pass
        self.is_connected = False
    
    async def send_message(self, message: str):
        """ç™¼é€æ¶ˆæ¯"""
        if not self.is_connected:
            print("Not connected to server")
            return
        
        try:
            # ç·¨ç¢¼æ¶ˆæ¯
            data = message.encode('utf-8')
            
            # ç™¼é€æ•¸æ“š
            self.writer.write(data)
            await self.writer.drain()
            
        except Exception as e:
            print(f"Error sending message: {e}")
            await self.disconnect()
    
    async def _receive_messages(self):
        """æ¥æ”¶æ¶ˆæ¯"""
        while self.is_running:
            try:
                # æ¥æ”¶æ•¸æ“š
                data = await self.reader.read(1024)
                if not data:
                    break
                
                # è§£ç¢¼æ•¸æ“š
                message = data.decode('utf-8')
                print(f"Received: {message}")
            
            except Exception as e:
                print(f"Error receiving message: {e}")
                break
        
        await self.disconnect()

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    # å‰µå»ºå®¢æˆ¶ç«¯
    client = AsyncSocketClient()
    
    try:
        # é€£æ¥åˆ°æœå‹™å™¨
        await client.connect()
        
        # ç™¼é€æ¶ˆæ¯
        await client.send_message("Hello, server!")
        
        # ç­‰å¾…ä¸€æ®µæ™‚é–“
        await asyncio.sleep(5)
        
        # ç™¼é€å¦ä¸€æ¢æ¶ˆæ¯
        await client.send_message("Goodbye, server!")
        
        # ç­‰å¾…ä¸€æ®µæ™‚é–“
        await asyncio.sleep(5)
    
    finally:
        # æ–·é–‹é€£æ¥
        await client.disconnect()

if __name__ == '__main__':
    asyncio.run(main())
```

## ç·´ç¿’é¡Œ

1. **ç•°æ­¥Socketæœå‹™å™¨**
   é–‹ç™¼ä¸€å€‹ç•°æ­¥Socketæœå‹™å™¨ï¼š
   - æ”¯æŒå¤šå®¢æˆ¶ç«¯é€£æ¥
   - è™•ç†å®¢æˆ¶ç«¯æ¶ˆæ¯
   - å„ªåŒ–è³‡æºä½¿ç”¨
   - æä¾›éŒ¯èª¤è™•ç†

2. **ç•°æ­¥Socketå®¢æˆ¶ç«¯**
   å‰µå»ºä¸€å€‹ç•°æ­¥Socketå®¢æˆ¶ç«¯ï¼š
   - æ”¯æŒæœå‹™å™¨é€£æ¥
   - è™•ç†æœå‹™å™¨æ¶ˆæ¯
   - å„ªåŒ–é€šä¿¡æ•ˆç‡
   - æä¾›é‡é€£æ©Ÿåˆ¶

3. **ç•°æ­¥ç¶²çµ¡æ¡†æ¶**
   å¯¦ç¾ä¸€å€‹ç•°æ­¥ç¶²çµ¡æ¡†æ¶ï¼š
   - æ”¯æŒå¤šç¨®å”è­°
   - æä¾›é«˜ç´šAPI
   - å„ªåŒ–æ€§èƒ½
   - è™•ç†è¤‡é›œå ´æ™¯

## å°æé†’ ğŸ’¡

1. ç•°æ­¥ç·¨ç¨‹
   - é¸æ“‡åˆé©æ¨¡å‹
   - è™•ç†å”ç¨‹
   - å„ªåŒ–äº‹ä»¶å¾ªç’°
   - é¿å…é˜»å¡æ“ä½œ

2. ç¶²çµ¡é€šä¿¡
   - è¨­è¨ˆé€šä¿¡å”è­°
   - è™•ç†æ•¸æ“šå‚³è¼¸
   - å„ªåŒ–ç¶²çµ¡é–‹éŠ·
   - è™•ç†ç¶²çµ¡ç•°å¸¸

3. æ€§èƒ½å„ªåŒ–
   - æ¸›å°‘ç¶²çµ¡å»¶é²
   - å„ªåŒ–æ•¸æ“šå‚³è¼¸
   - å¹³è¡¡è² è¼‰
   - æé«˜ååé‡

4. èª¿è©¦æŠ€å·§
   - ä½¿ç”¨ç¶²çµ¡å·¥å…·
   - åˆ†æé€šä¿¡å•é¡Œ
   - å„ªåŒ–é—œéµè·¯å¾‘
   - ç›£æ§ç¶²çµ¡ç‹€æ…‹

[ä¸Šä¸€ç« ï¼šç¶²çµ¡ç·¨ç¨‹åŸºç¤](086_ç¶²çµ¡ç·¨ç¨‹åŸºç¤.md) | [ä¸‹ä¸€ç« ï¼šæ•¸æ“šåº«ç·¨ç¨‹åŸºç¤](088_æ•¸æ“šåº«ç·¨ç¨‹åŸºç¤.md) 