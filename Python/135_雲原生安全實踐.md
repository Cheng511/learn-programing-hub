[ä¸Šä¸€ç« ï¼šé›²åŸç”Ÿå­˜å„²æ–¹æ¡ˆ](134_é›²åŸç”Ÿå­˜å„²æ–¹æ¡ˆ.md) | [ä¸‹ä¸€ç« ï¼šDevOpså¯¦è¸åŸºç¤](136_DevOpså¯¦è¸åŸºç¤.md)

# Python é›²åŸç”Ÿå®‰å…¨å¯¦è¸ ğŸ”’

## 1. å®‰å…¨åŸºç¤è¨­æ–½

### 1.1 èº«ä»½èªè­‰èˆ‡æˆæ¬Š

```python
from typing import Dict, List, Optional
import jwt
from datetime import datetime, timedelta

class SecurityManager:
    """å®‰å…¨ç®¡ç†å™¨"""
    def __init__(self, secret_key: str):
        self.secret_key = secret_key
    
    def generate_token(self,
                      user_id: str,
                      roles: List[str],
                      expiration: int = 3600) -> str:
        """ç”Ÿæˆ JWT token"""
        payload = {
            "user_id": user_id,
            "roles": roles,
            "exp": datetime.utcnow() + timedelta(seconds=expiration),
            "iat": datetime.utcnow()
        }
        
        return jwt.encode(
            payload,
            self.secret_key,
            algorithm="HS256"
        )
    
    def verify_token(self, token: str) -> Optional[Dict]:
        """é©—è­‰ token"""
        try:
            return jwt.decode(
                token,
                self.secret_key,
                algorithms=["HS256"]
            )
        except jwt.InvalidTokenError:
            return None
```

### 1.2 RBAC é…ç½®

```python
from kubernetes import client, config
from typing import List

class RBACManager:
    """RBAC ç®¡ç†å™¨"""
    def __init__(self):
        config.load_kube_config()
        self.rbac_v1 = client.RbacAuthorizationV1Api()
    
    def create_role(self,
                    name: str,
                    namespace: str,
                    rules: List[Dict]) -> bool:
        """å‰µå»ºè§’è‰²"""
        try:
            role = client.V1Role(
                metadata=client.V1ObjectMeta(
                    name=name,
                    namespace=namespace
                ),
                rules=[
                    client.V1PolicyRule(**rule)
                    for rule in rules
                ]
            )
            
            self.rbac_v1.create_namespaced_role(
                namespace=namespace,
                body=role
            )
            return True
        except Exception as e:
            print(f"Failed to create role: {e}")
            return False
    
    def create_role_binding(self,
                          name: str,
                          namespace: str,
                          role_name: str,
                          service_account: str) -> bool:
        """å‰µå»ºè§’è‰²ç¶å®š"""
        try:
            role_binding = client.V1RoleBinding(
                metadata=client.V1ObjectMeta(
                    name=name,
                    namespace=namespace
                ),
                role_ref=client.V1RoleRef(
                    api_group="rbac.authorization.k8s.io",
                    kind="Role",
                    name=role_name
                ),
                subjects=[
                    client.V1Subject(
                        kind="ServiceAccount",
                        name=service_account,
                        namespace=namespace
                    )
                ]
            )
            
            self.rbac_v1.create_namespaced_role_binding(
                namespace=namespace,
                body=role_binding
            )
            return True
        except Exception as e:
            print(f"Failed to create role binding: {e}")
            return False
```

## 2. ç¶²çµ¡å®‰å…¨

### 2.1 ç¶²çµ¡ç­–ç•¥

```python
from kubernetes import client

class NetworkPolicyManager:
    """ç¶²çµ¡ç­–ç•¥ç®¡ç†å™¨"""
    def __init__(self):
        config.load_kube_config()
        self.networking_v1 = client.NetworkingV1Api()
    
    def create_network_policy(self,
                            name: str,
                            namespace: str,
                            pod_selector: Dict[str, List[str]],
                            ingress_rules: List[Dict] = None,
                            egress_rules: List[Dict] = None) -> bool:
        """å‰µå»ºç¶²çµ¡ç­–ç•¥"""
        try:
            policy = client.V1NetworkPolicy(
                metadata=client.V1ObjectMeta(
                    name=name,
                    namespace=namespace
                ),
                spec=client.V1NetworkPolicySpec(
                    pod_selector=client.V1LabelSelector(
                        match_labels=pod_selector
                    ),
                    ingress=ingress_rules,
                    egress=egress_rules,
                    policy_types=["Ingress", "Egress"]
                )
            )
            
            self.networking_v1.create_namespaced_network_policy(
                namespace=namespace,
                body=policy
            )
            return True
        except Exception as e:
            print(f"Failed to create network policy: {e}")
            return False
```

## 3. å®¹å™¨å®‰å…¨

### 3.1 å®¹å™¨æƒæ

```python
import docker
import requests
from typing import Dict, List

class ContainerScanner:
    """å®¹å™¨å®‰å…¨æƒæå™¨"""
    def __init__(self, registry_url: str):
        self.registry_url = registry_url
        self.client = docker.from_env()
    
    def scan_image(self, image_name: str) -> Dict:
        """æƒæå®¹å™¨é¡åƒ"""
        try:
            # æ‹‰å–é¡åƒ
            image = self.client.images.pull(image_name)
            
            # åŸ·è¡Œæ¼æ´æƒæ
            vulnerabilities = self._scan_vulnerabilities(image.id)
            
            # æª¢æŸ¥é…ç½®
            config_issues = self._check_configuration(image.id)
            
            return {
                "image": image_name,
                "vulnerabilities": vulnerabilities,
                "config_issues": config_issues
            }
        except Exception as e:
            print(f"Scan failed: {e}")
            return {}
    
    def _scan_vulnerabilities(self, image_id: str) -> List[Dict]:
        """æƒææ¼æ´"""
        # å¯¦ç¾å…·é«”çš„æ¼æ´æƒæé‚è¼¯
        pass
    
    def _check_configuration(self, image_id: str) -> List[Dict]:
        """æª¢æŸ¥é…ç½®å•é¡Œ"""
        # å¯¦ç¾å…·é«”çš„é…ç½®æª¢æŸ¥é‚è¼¯
        pass
```

### 3.2 é‹è¡Œæ™‚å®‰å…¨

```python
import psutil
import docker
from typing import Dict, List

class RuntimeSecurity:
    """é‹è¡Œæ™‚å®‰å…¨ç›£æ§"""
    def __init__(self):
        self.client = docker.from_env()
    
    def monitor_container(self,
                         container_id: str) -> Dict:
        """ç›£æ§å®¹å™¨é‹è¡Œæ™‚è¡Œç‚º"""
        try:
            container = self.client.containers.get(container_id)
            
            # æ”¶é›†ç³»çµ±èª¿ç”¨
            syscalls = self._collect_syscalls(container)
            
            # ç›£æ§ç¶²çµ¡æ´»å‹•
            network = self._monitor_network(container)
            
            # æª¢æŸ¥æ–‡ä»¶ç³»çµ±æ´»å‹•
            filesystem = self._monitor_filesystem(container)
            
            return {
                "container_id": container_id,
                "syscalls": syscalls,
                "network": network,
                "filesystem": filesystem
            }
        except Exception as e:
            print(f"Monitoring failed: {e}")
            return {}
    
    def _collect_syscalls(self,
                         container: docker.models.containers.Container
                         ) -> List[Dict]:
        """æ”¶é›†ç³»çµ±èª¿ç”¨"""
        # å¯¦ç¾ç³»çµ±èª¿ç”¨ç›£æ§é‚è¼¯
        pass
    
    def _monitor_network(self,
                        container: docker.models.containers.Container
                        ) -> Dict:
        """ç›£æ§ç¶²çµ¡æ´»å‹•"""
        # å¯¦ç¾ç¶²çµ¡ç›£æ§é‚è¼¯
        pass
    
    def _monitor_filesystem(self,
                          container: docker.models.containers.Container
                          ) -> Dict:
        """ç›£æ§æ–‡ä»¶ç³»çµ±æ´»å‹•"""
        # å¯¦ç¾æ–‡ä»¶ç³»çµ±ç›£æ§é‚è¼¯
        pass
```

## 4. å¯†é‘°ç®¡ç†

### 4.1 Vault é›†æˆ

```python
import hvac
from typing import Dict, Optional

class VaultManager:
    """HashiCorp Vault ç®¡ç†å™¨"""
    def __init__(self,
                 url: str,
                 token: str):
        self.client = hvac.Client(
            url=url,
            token=token
        )
    
    def write_secret(self,
                    path: str,
                    data: Dict) -> bool:
        """å¯«å…¥å¯†é‘°"""
        try:
            self.client.secrets.kv.v2.create_or_update_secret(
                path=path,
                secret=data
            )
            return True
        except Exception as e:
            print(f"Failed to write secret: {e}")
            return False
    
    def read_secret(self,
                    path: str) -> Optional[Dict]:
        """è®€å–å¯†é‘°"""
        try:
            response = self.client.secrets.kv.v2.read_secret_version(
                path=path
            )
            return response["data"]["data"]
        except Exception as e:
            print(f"Failed to read secret: {e}")
            return None
```

## 5. å®‰å…¨ç›£æ§

### 5.1 å¯©è¨ˆæ—¥èªŒ

```python
import logging
from datetime import datetime
from typing import Dict, Optional

class AuditLogger:
    """å¯©è¨ˆæ—¥èªŒç®¡ç†å™¨"""
    def __init__(self, log_file: str):
        self.logger = logging.getLogger("audit")
        handler = logging.FileHandler(log_file)
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        handler.setFormatter(formatter)
        self.logger.addHandler(handler)
        self.logger.setLevel(logging.INFO)
    
    def log_event(self,
                  event_type: str,
                  user: str,
                  resource: str,
                  action: str,
                  status: str,
                  details: Optional[Dict] = None):
        """è¨˜éŒ„å¯©è¨ˆäº‹ä»¶"""
        event = {
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": event_type,
            "user": user,
            "resource": resource,
            "action": action,
            "status": status,
            "details": details or {}
        }
        
        self.logger.info(f"Audit event: {event}")
```

## ç·´ç¿’é¡Œ ğŸƒâ€â™‚ï¸

1. å¯¦ç¾å®Œæ•´çš„èº«ä»½èªè­‰ç³»çµ±ï¼š
   - OAuth2 é›†æˆ
   - å¤šå› ç´ èªè­‰
   - Session ç®¡ç†
   - æ¬Šé™æ§åˆ¶

2. é–‹ç™¼å®¹å™¨å®‰å…¨æƒæå·¥å…·ï¼š
   - æ¼æ´æ•¸æ“šåº«
   - é…ç½®æª¢æŸ¥
   - ä¾è³´åˆ†æ
   - å ±å‘Šç”Ÿæˆ

3. å¯¦ç¾å®‰å…¨ç›£æ§ç³»çµ±ï¼š
   - å³æ™‚å‘Šè­¦
   - æ—¥èªŒåˆ†æ
   - ç•°å¸¸æª¢æ¸¬
   - äº‹ä»¶éŸ¿æ‡‰

4. å‰µå»ºå¯†é‘°è¼ªæ›ç³»çµ±ï¼š
   - è‡ªå‹•è¼ªæ›
   - ç‰ˆæœ¬æ§åˆ¶
   - è¨ªå•å¯©è¨ˆ
   - å‚™ä»½æ¢å¾©

5. é–‹ç™¼ç¶²çµ¡å®‰å…¨å·¥å…·ï¼š
   - æµé‡ç›£æ§
   - é˜²ç«ç‰†é…ç½®
   - å…¥ä¾µæª¢æ¸¬
   - å®‰å…¨åŸºç·šæª¢æŸ¥

## å°çµ ğŸ“

- äº†è§£äº†é›²åŸç”Ÿå®‰å…¨çš„åŸºæœ¬æ¦‚å¿µ
- æŒæ¡äº†èº«ä»½èªè­‰èˆ‡æˆæ¬Šçš„å¯¦ç¾
- å­¸æœƒäº†å®¹å™¨å®‰å…¨æƒæå’Œç›£æ§
- ç†è§£äº†å¯†é‘°ç®¡ç†çš„é‡è¦æ€§
- æŒæ¡äº†å®‰å…¨å¯©è¨ˆçš„æ–¹æ³•

## å»¶ä¼¸é–±è®€ ğŸ“š

1. Kubernetes å®‰å…¨æŒ‡å—
2. Docker å®‰å…¨æœ€ä½³å¯¦è¸
3. HashiCorp Vault æ–‡æª”
4. é›²åŸç”Ÿå®‰å…¨ç™½çš®æ›¸
5. OWASP å®¹å™¨å®‰å…¨æŒ‡å—

[ä¸Šä¸€ç« ï¼šé›²åŸç”Ÿå­˜å„²æ–¹æ¡ˆ](134_é›²åŸç”Ÿå­˜å„²æ–¹æ¡ˆ.md) | [ä¸‹ä¸€ç« ï¼šDevOpså¯¦è¸åŸºç¤](136_DevOpså¯¦è¸åŸºç¤.md) 