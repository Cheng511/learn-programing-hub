[ä¸Šä¸€ç« ï¼šè»Ÿä»¶æ¸¬è©¦é€²éš](079_è»Ÿä»¶æ¸¬è©¦é€²éš.md) | [ä¸‹ä¸€ç« ï¼šæ€§èƒ½å„ªåŒ–é€²éš](081_æ€§èƒ½å„ªåŒ–é€²éš.md)

# Python æ€§èƒ½å„ªåŒ–åŸºç¤ ğŸš€

## æ€§èƒ½åˆ†æ

### 1. æ€§èƒ½åˆ†æå™¨

```python
import cProfile
import pstats
import io
import time
import functools
from typing import Callable, Any, Dict, List
import sys
import os

class PerformanceProfiler:
    def __init__(self):
        """åˆå§‹åŒ–æ€§èƒ½åˆ†æå™¨"""
        self.profiler = cProfile.Profile()
        self.stats = None
        self.results: Dict[str, Dict[str, Any]] = {}
    
    def profile_function(self, func: Callable) -> Callable:
        """å‡½æ•¸æ€§èƒ½åˆ†æè£é£¾å™¨"""
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            # é–‹å§‹åˆ†æ
            self.profiler.enable()
            
            # åŸ·è¡Œå‡½æ•¸
            start_time = time.time()
            result = func(*args, **kwargs)
            end_time = time.time()
            
            # åœæ­¢åˆ†æ
            self.profiler.disable()
            
            # è¨˜éŒ„çµæœ
            func_name = func.__name__
            self.results[func_name] = {
                'execution_time': end_time - start_time,
                'stats': self._get_stats()
            }
            
            return result
        return wrapper
    
    def profile_code(self, code: str, globals_dict: Dict = None, locals_dict: Dict = None):
        """åˆ†æä»£ç¢¼å¡Š"""
        # é–‹å§‹åˆ†æ
        self.profiler.enable()
        
        # åŸ·è¡Œä»£ç¢¼
        start_time = time.time()
        exec(code, globals_dict or {}, locals_dict or {})
        end_time = time.time()
        
        # åœæ­¢åˆ†æ
        self.profiler.disable()
        
        # è¨˜éŒ„çµæœ
        self.results['code_block'] = {
            'execution_time': end_time - start_time,
            'stats': self._get_stats()
        }
    
    def _get_stats(self) -> Dict[str, Any]:
        """ç²å–çµ±è¨ˆä¿¡æ¯"""
        # å‰µå»ºçµ±è¨ˆå°è±¡
        s = io.StringIO()
        ps = pstats.Stats(self.profiler, stream=s).sort_stats('cumulative')
        
        # ç²å–çµ±è¨ˆä¿¡æ¯
        ps.print_stats()
        stats_text = s.getvalue()
        
        # è§£æçµ±è¨ˆä¿¡æ¯
        stats = {
            'total_calls': 0,
            'total_time': 0,
            'primitive_calls': 0,
            'function_stats': {}
        }
        
        for line in stats_text.split('\n'):
            if line.strip() and not line.startswith('ncalls'):
                parts = line.split()
                if len(parts) >= 6:
                    func_name = ' '.join(parts[5:])
                    stats['function_stats'][func_name] = {
                        'calls': int(parts[0]),
                        'primitive_calls': int(parts[1]),
                        'total_time': float(parts[2]),
                        'per_call': float(parts[3]),
                        'cumulative_time': float(parts[4])
                    }
                    stats['total_calls'] += int(parts[0])
                    stats['primitive_calls'] += int(parts[1])
                    stats['total_time'] += float(parts[2])
        
        return stats
    
    def print_results(self, output_file: str = None):
        """æ‰“å°åˆ†æçµæœ"""
        output = []
        output.append("Performance Analysis Results")
        output.append("=" * 50)
        
        for func_name, result in self.results.items():
            output.append(f"\nFunction: {func_name}")
            output.append(f"Execution Time: {result['execution_time']:.6f} seconds")
            
            stats = result['stats']
            output.append("\nStatistics:")
            output.append(f"Total Calls: {stats['total_calls']}")
            output.append(f"Primitive Calls: {stats['primitive_calls']}")
            output.append(f"Total Time: {stats['total_time']:.6f} seconds")
            
            output.append("\nFunction Details:")
            for func, func_stats in stats['function_stats'].items():
                output.append(f"\n  {func}:")
                output.append(f"    Calls: {func_stats['calls']}")
                output.append(f"    Primitive Calls: {func_stats['primitive_calls']}")
                output.append(f"    Total Time: {func_stats['total_time']:.6f} seconds")
                output.append(f"    Time per Call: {func_stats['per_call']:.6f} seconds")
                output.append(f"    Cumulative Time: {func_stats['cumulative_time']:.6f} seconds")
        
        output_text = "\n".join(output)
        
        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(output_text)
        else:
            print(output_text)

# ä½¿ç”¨ç¤ºä¾‹
@PerformanceProfiler().profile_function
def fibonacci(n: int) -> int:
    """è¨ˆç®—æ–æ³¢é‚£å¥‘æ•¸åˆ—"""
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

@PerformanceProfiler().profile_function
def factorial(n: int) -> int:
    """è¨ˆç®—éšä¹˜"""
    if n <= 1:
        return 1
    return n * factorial(n-1)

def main():
    # å‰µå»ºåˆ†æå™¨
    profiler = PerformanceProfiler()
    
    # åˆ†æå‡½æ•¸
    print("Testing Fibonacci:")
    result = fibonacci(10)
    print(f"Result: {result}")
    
    print("\nTesting Factorial:")
    result = factorial(10)
    print(f"Result: {result}")
    
    # åˆ†æä»£ç¢¼å¡Š
    print("\nTesting Code Block:")
    code = """
def sum_squares(n):
    return sum(i*i for i in range(n))
result = sum_squares(1000)
"""
    profiler.profile_code(code)
    
    # æ‰“å°çµæœ
    profiler.print_results("performance_report.txt")

if __name__ == '__main__':
    main()
```

### 2. å…§å­˜åˆ†æå™¨

```python
import tracemalloc
import sys
import os
from typing import Dict, List, Any, Optional
import time
import functools

class MemoryProfiler:
    def __init__(self):
        """åˆå§‹åŒ–å…§å­˜åˆ†æå™¨"""
        self.snapshots: List[tracemalloc.Snapshot] = []
        self.results: Dict[str, Dict[str, Any]] = {}
    
    def start(self):
        """é–‹å§‹è¿½è¹¤å…§å­˜"""
        tracemalloc.start()
    
    def stop(self):
        """åœæ­¢è¿½è¹¤å…§å­˜"""
        tracemalloc.stop()
    
    def take_snapshot(self, name: str = None):
        """æ‹æ”å…§å­˜å¿«ç…§"""
        snapshot = tracemalloc.take_snapshot()
        self.snapshots.append(snapshot)
        
        if name:
            self.results[name] = self._analyze_snapshot(snapshot)
    
    def profile_function(self, func: Callable) -> Callable:
        """å‡½æ•¸å…§å­˜åˆ†æè£é£¾å™¨"""
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            # é–‹å§‹è¿½è¹¤
            self.start()
            
            # æ‹æ”åˆå§‹å¿«ç…§
            self.take_snapshot(f"{func.__name__}_start")
            
            # åŸ·è¡Œå‡½æ•¸
            result = func(*args, **kwargs)
            
            # æ‹æ”çµæŸå¿«ç…§
            self.take_snapshot(f"{func.__name__}_end")
            
            # åœæ­¢è¿½è¹¤
            self.stop()
            
            return result
        return wrapper
    
    def _analyze_snapshot(self, snapshot: tracemalloc.Snapshot) -> Dict[str, Any]:
        """åˆ†æå¿«ç…§"""
        stats = snapshot.statistics('lineno')
        
        return {
            'total_size': sum(stat.size for stat in stats),
            'total_count': sum(stat.count for stat in stats),
            'top_stats': [
                {
                    'file': stat.traceback[0].filename,
                    'line': stat.traceback[0].lineno,
                    'size': stat.size,
                    'count': stat.count
                }
                for stat in stats[:10]
            ]
        }
    
    def compare_snapshots(self, snapshot1: str, snapshot2: str) -> Dict[str, Any]:
        """æ¯”è¼ƒå…©å€‹å¿«ç…§"""
        if snapshot1 not in self.results or snapshot2 not in self.results:
            return {}
        
        stats1 = self.results[snapshot1]
        stats2 = self.results[snapshot2]
        
        return {
            'size_diff': stats2['total_size'] - stats1['total_size'],
            'count_diff': stats2['total_count'] - stats1['total_count'],
            'top_changes': self._compare_top_stats(
                stats1['top_stats'],
                stats2['top_stats']
            )
        }
    
    def _compare_top_stats(self, stats1: List[Dict], stats2: List[Dict]) -> List[Dict]:
        """æ¯”è¼ƒé ‚éƒ¨çµ±è¨ˆä¿¡æ¯"""
        changes = []
        
        # å‰µå»ºæ–‡ä»¶è¡Œè™Ÿæ˜ å°„
        stats1_map = {
            (stat['file'], stat['line']): stat
            for stat in stats1
        }
        
        stats2_map = {
            (stat['file'], stat['line']): stat
            for stat in stats2
        }
        
        # æ¯”è¼ƒæ‰€æœ‰ä½ç½®
        all_locations = set(stats1_map.keys()) | set(stats2_map.keys())
        
        for location in all_locations:
            stat1 = stats1_map.get(location)
            stat2 = stats2_map.get(location)
            
            if stat1 and stat2:
                # å…©å€‹å¿«ç…§éƒ½æœ‰é€™å€‹ä½ç½®
                if stat1['size'] != stat2['size'] or stat1['count'] != stat2['count']:
                    changes.append({
                        'file': location[0],
                        'line': location[1],
                        'size_diff': stat2['size'] - stat1['size'],
                        'count_diff': stat2['count'] - stat1['count']
                    })
            elif stat1:
                # åªåœ¨ç¬¬ä¸€å€‹å¿«ç…§ä¸­
                changes.append({
                    'file': location[0],
                    'line': location[1],
                    'size_diff': -stat1['size'],
                    'count_diff': -stat1['count'],
                    'removed': True
                })
            else:
                # åªåœ¨ç¬¬äºŒå€‹å¿«ç…§ä¸­
                changes.append({
                    'file': location[0],
                    'line': location[1],
                    'size_diff': stat2['size'],
                    'count_diff': stat2['count'],
                    'added': True
                })
        
        return sorted(changes, key=lambda x: abs(x['size_diff']), reverse=True)
    
    def print_results(self, output_file: str = None):
        """æ‰“å°åˆ†æçµæœ"""
        output = []
        output.append("Memory Analysis Results")
        output.append("=" * 50)
        
        for name, result in self.results.items():
            output.append(f"\nSnapshot: {name}")
            output.append(f"Total Size: {result['total_size'] / 1024:.2f} KB")
            output.append(f"Total Count: {result['total_count']}")
            
            output.append("\nTop Memory Usage:")
            for stat in result['top_stats']:
                output.append(f"\n  File: {stat['file']}")
                output.append(f"    Line: {stat['line']}")
                output.append(f"    Size: {stat['size'] / 1024:.2f} KB")
                output.append(f"    Count: {stat['count']}")
        
        output_text = "\n".join(output)
        
        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(output_text)
        else:
            print(output_text)

# ä½¿ç”¨ç¤ºä¾‹
@MemoryProfiler().profile_function
def create_large_list(n: int) -> List[int]:
    """å‰µå»ºå¤§åˆ—è¡¨"""
    return [i for i in range(n)]

@MemoryProfiler().profile_function
def create_large_dict(n: int) -> Dict[int, int]:
    """å‰µå»ºå¤§å­—å…¸"""
    return {i: i for i in range(n)}

def main():
    # å‰µå»ºåˆ†æå™¨
    profiler = MemoryProfiler()
    
    # åˆ†æå‡½æ•¸
    print("Testing List Creation:")
    result = create_large_list(1000000)
    print(f"List size: {len(result)}")
    
    print("\nTesting Dict Creation:")
    result = create_large_dict(1000000)
    print(f"Dict size: {len(result)}")
    
    # æ‰“å°çµæœ
    profiler.print_results("memory_report.txt")
    
    # æ¯”è¼ƒå¿«ç…§
    if 'create_large_list_start' in profiler.results and 'create_large_list_end' in profiler.results:
        print("\nComparing Snapshots:")
        comparison = profiler.compare_snapshots(
            'create_large_list_start',
            'create_large_list_end'
        )
        print(f"Size Difference: {comparison['size_diff'] / 1024:.2f} KB")
        print(f"Count Difference: {comparison['count_diff']}")

if __name__ == '__main__':
    main()
```

## ç·´ç¿’é¡Œ

1. **æ€§èƒ½åˆ†æå·¥å…·**
   é–‹ç™¼ä¸€å€‹æ€§èƒ½åˆ†æå·¥å…·ï¼š
   - æ”¯æŒå¤šç¨®åˆ†ææŒ‡æ¨™
   - ç”Ÿæˆåˆ†æå ±å‘Š
   - æä¾›APIæ¥å£
   - å„ªåŒ–åˆ†ææ•ˆç‡

2. **å…§å­˜åˆ†æå™¨**
   å‰µå»ºä¸€å€‹å…§å­˜åˆ†æå™¨ï¼š
   - è¿½è¹¤å…§å­˜ä½¿ç”¨
   - åˆ†æå…§å­˜æ´©æ¼
   - ç”Ÿæˆå…§å­˜å ±å‘Š
   - æä¾›å„ªåŒ–å»ºè­°

3. **æ€§èƒ½å„ªåŒ–å·¥å…·**
   å¯¦ç¾ä¸€å€‹æ€§èƒ½å„ªåŒ–å·¥å…·ï¼š
   - è­˜åˆ¥æ€§èƒ½ç“¶é ¸
   - æä¾›å„ªåŒ–æ–¹æ¡ˆ
   - ç”Ÿæˆå„ªåŒ–å ±å‘Š
   - è‡ªå‹•åŒ–å„ªåŒ–

## å°æé†’ ğŸ’¡

1. æ€§èƒ½åˆ†æ
   - é¸æ“‡åˆé©æŒ‡æ¨™
   - åˆ†æé—œéµè·¯å¾‘
   - å„ªåŒ–ç†±é»ä»£ç¢¼
   - å®šæœŸæ€§èƒ½æ¸¬è©¦

2. å…§å­˜ç®¡ç†
   - ç›£æ§å…§å­˜ä½¿ç”¨
   - é¿å…å…§å­˜æ´©æ¼
   - å„ªåŒ–æ•¸æ“šçµæ§‹
   - æ§åˆ¶å…§å­˜åˆ†é…

3. å„ªåŒ–ç­–ç•¥
   - ç®—æ³•å„ªåŒ–
   - æ•¸æ“šçµæ§‹å„ªåŒ–
   - ä¸¦ç™¼å„ªåŒ–
   - ç·©å­˜å„ªåŒ–

4. èª¿è©¦æŠ€å·§
   - ä½¿ç”¨åˆ†æå·¥å…·
   - å®šä½æ€§èƒ½å•é¡Œ
   - é©—è­‰å„ªåŒ–æ•ˆæœ
   - ç›£æ§ç³»çµ±è³‡æº

[ä¸Šä¸€ç« ï¼šè»Ÿä»¶æ¸¬è©¦é€²éš](079_è»Ÿä»¶æ¸¬è©¦é€²éš.md) | [ä¸‹ä¸€ç« ï¼šæ€§èƒ½å„ªåŒ–é€²éš](081_æ€§èƒ½å„ªåŒ–é€²éš.md) 