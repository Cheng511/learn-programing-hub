[ä¸Šä¸€ç« ï¼šç¶²è·¯ç¨‹å¼è¨­è¨ˆåŸºç¤](039_ç¶²è·¯ç¨‹å¼è¨­è¨ˆåŸºç¤.md)

# Python è³‡æ–™åº«åŸºç¤ ğŸ’¾

## SQLite è³‡æ–™åº«æ“ä½œ

### 1. åŸºæœ¬é€£æ¥å’ŒæŸ¥è©¢

```python
import sqlite3

# å»ºç«‹é€£æ¥
conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# å‰µå»ºè¡¨æ ¼
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE,
    age INTEGER
)
''')

# æ’å…¥æ•¸æ“š
cursor.execute('''
INSERT INTO users (name, email, age) VALUES (?, ?, ?)
''', ('Alice', 'alice@example.com', 25))

# æäº¤æ›´æ”¹
conn.commit()

# æŸ¥è©¢æ•¸æ“š
cursor.execute('SELECT * FROM users')
users = cursor.fetchall()
for user in users:
    print(f"ID: {user[0]}, å§“å: {user[1]}, éƒµç®±: {user[2]}, å¹´é½¡: {user[3]}")

# é—œé–‰é€£æ¥
conn.close()
```

### 2. ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
import sqlite3
from contextlib import contextmanager

@contextmanager
def database_connection(db_name):
    conn = sqlite3.connect(db_name)
    try:
        yield conn
    finally:
        conn.close()

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
with database_connection('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM users WHERE age > ?', (20,))
    results = cursor.fetchall()
    for row in results:
        print(row)
```

## MySQL è³‡æ–™åº«æ“ä½œ

### 1. åŸºæœ¬æ“ä½œ

```python
import mysql.connector

# å»ºç«‹é€£æ¥
config = {
    'user': 'root',
    'password': 'password',
    'host': 'localhost',
    'database': 'example_db'
}

conn = mysql.connector.connect(**config)
cursor = conn.cursor()

# å‰µå»ºè¡¨æ ¼
cursor.execute('''
CREATE TABLE IF NOT EXISTS products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10, 2),
    stock INT DEFAULT 0
)
''')

# æ’å…¥æ•¸æ“š
sql = "INSERT INTO products (name, price, stock) VALUES (%s, %s, %s)"
values = ("Python Book", 29.99, 100)
cursor.execute(sql, values)

# æäº¤æ›´æ”¹
conn.commit()

# æŸ¥è©¢æ•¸æ“š
cursor.execute("SELECT * FROM products")
for (id, name, price, stock) in cursor:
    print(f"å•†å“ï¼š{name}, åƒ¹æ ¼ï¼š${price}, åº«å­˜ï¼š{stock}")

# é—œé–‰é€£æ¥
cursor.close()
conn.close()
```

### 2. æ‰¹é‡æ“ä½œ

```python
import mysql.connector
from mysql.connector import Error

def bulk_insert(connection, products):
    try:
        cursor = connection.cursor()
        sql = "INSERT INTO products (name, price, stock) VALUES (%s, %s, %s)"
        cursor.executemany(sql, products)
        connection.commit()
        print(f"æˆåŠŸæ’å…¥ {cursor.rowcount} æ¢è¨˜éŒ„")
    except Error as e:
        print(f"éŒ¯èª¤ï¼š{e}")
    finally:
        cursor.close()

# æ‰¹é‡æ’å…¥ç¤ºä¾‹
products = [
    ("Book 1", 19.99, 50),
    ("Book 2", 29.99, 30),
    ("Book 3", 39.99, 20)
]

conn = mysql.connector.connect(**config)
bulk_insert(conn, products)
conn.close()
```

## PostgreSQL è³‡æ–™åº«æ“ä½œ

### 1. åŸºæœ¬æ“ä½œ

```python
import psycopg2

# å»ºç«‹é€£æ¥
conn = psycopg2.connect(
    dbname="example_db",
    user="postgres",
    password="password",
    host="localhost",
    port="5432"
)

cursor = conn.cursor()

# å‰µå»ºè¡¨æ ¼
cursor.execute('''
CREATE TABLE IF NOT EXISTS employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    department VARCHAR(50),
    salary NUMERIC(10, 2)
)
''')

# æ’å…¥æ•¸æ“š
cursor.execute('''
INSERT INTO employees (name, department, salary)
VALUES (%s, %s, %s)
''', ('John Doe', 'IT', 50000))

# æäº¤æ›´æ”¹
conn.commit()

# æŸ¥è©¢æ•¸æ“š
cursor.execute("SELECT * FROM employees")
rows = cursor.fetchall()
for row in rows:
    print(f"å“¡å·¥ï¼š{row[1]}, éƒ¨é–€ï¼š{row[2]}, è–ªè³‡ï¼š${row[3]}")

# é—œé–‰é€£æ¥
cursor.close()
conn.close()
```

### 2. äº‹å‹™è™•ç†

```python
import psycopg2
from psycopg2 import Error

def transfer_money(conn, from_account, to_account, amount):
    try:
        cursor = conn.cursor()
        
        # é–‹å§‹äº‹å‹™
        cursor.execute("BEGIN")
        
        # æ‰£é™¤é‡‘é¡
        cursor.execute("""
            UPDATE accounts 
            SET balance = balance - %s 
            WHERE account_id = %s
        """, (amount, from_account))
        
        # æ·»åŠ é‡‘é¡
        cursor.execute("""
            UPDATE accounts 
            SET balance = balance + %s 
            WHERE account_id = %s
        """, (amount, to_account))
        
        # æäº¤äº‹å‹™
        conn.commit()
        print("è½‰è³¬æˆåŠŸ")
        
    except Error as e:
        # å›æ»¾äº‹å‹™
        conn.rollback()
        print(f"è½‰è³¬å¤±æ•—ï¼š{e}")
        
    finally:
        cursor.close()

# ä½¿ç”¨äº‹å‹™
conn = psycopg2.connect(dbname="bank_db", user="postgres", password="password")
transfer_money(conn, "A001", "A002", 1000)
conn.close()
```

## ORM æ¡†æ¶ï¼šSQLAlchemy

### 1. å®šç¾©æ¨¡å‹

```python
from sqlalchemy import create_engine, Column, Integer, String, Float
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# å‰µå»ºåŸºé¡
Base = declarative_base()

# å®šç¾©æ¨¡å‹é¡
class Product(Base):
    __tablename__ = 'products'
    
    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)
    price = Column(Float)
    description = Column(String(200))
    
    def __repr__(self):
        return f"<Product(name='{self.name}', price={self.price})>"

# å‰µå»ºæ•¸æ“šåº«å¼•æ“
engine = create_engine('sqlite:///products.db')
Base.metadata.create_all(engine)

# å‰µå»ºæœƒè©±
Session = sessionmaker(bind=engine)
session = Session()
```

### 2. CRUD æ“ä½œ

```python
# å‰µå»º
new_product = Product(name='Python Book', price=29.99, description='A great book')
session.add(new_product)
session.commit()

# è®€å–
products = session.query(Product).all()
for product in products:
    print(product)

# æ›´æ–°
product = session.query(Product).filter_by(name='Python Book').first()
if product:
    product.price = 34.99
    session.commit()

# åˆªé™¤
product = session.query(Product).filter_by(name='Python Book').first()
if product:
    session.delete(product)
    session.commit()
```

### 3. é«˜ç´šæŸ¥è©¢

```python
from sqlalchemy import and_, or_, not_

# è¤‡é›œæ¢ä»¶æŸ¥è©¢
results = session.query(Product).filter(
    and_(
        Product.price < 50,
        or_(
            Product.name.like('%Python%'),
            Product.name.like('%Java%')
        )
    )
).all()

# æ’åº
products = session.query(Product).order_by(Product.price.desc()).all()

# åˆ†é 
page = 1
per_page = 10
products = session.query(Product).offset((page-1)*per_page).limit(per_page).all()
```

## å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### 1. ç°¡å–®çš„åº«å­˜ç®¡ç†ç³»çµ±

```python
from sqlalchemy import create_engine, Column, Integer, String, Float, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime

Base = declarative_base()

class Inventory(Base):
    __tablename__ = 'inventory'
    
    id = Column(Integer, primary_key=True)
    product_name = Column(String(100), nullable=False)
    quantity = Column(Integer, default=0)
    price = Column(Float)
    last_updated = Column(DateTime, default=datetime.now)
    
    def __repr__(self):
        return f"<Inventory(product='{self.product_name}', quantity={self.quantity})>"

class InventoryManager:
    def __init__(self, db_url):
        self.engine = create_engine(db_url)
        Base.metadata.create_all(self.engine)
        self.Session = sessionmaker(bind=self.engine)
    
    def add_product(self, name, quantity, price):
        session = self.Session()
        try:
            product = Inventory(
                product_name=name,
                quantity=quantity,
                price=price
            )
            session.add(product)
            session.commit()
            return True
        except Exception as e:
            session.rollback()
            print(f"æ·»åŠ ç”¢å“å¤±æ•—ï¼š{e}")
            return False
        finally:
            session.close()
    
    def update_quantity(self, product_id, change):
        session = self.Session()
        try:
            product = session.query(Inventory).get(product_id)
            if product:
                product.quantity += change
                product.last_updated = datetime.now()
                session.commit()
                return True
            return False
        except Exception as e:
            session.rollback()
            print(f"æ›´æ–°åº«å­˜å¤±æ•—ï¼š{e}")
            return False
        finally:
            session.close()
    
    def get_low_stock_products(self, threshold=10):
        session = self.Session()
        try:
            return session.query(Inventory).filter(
                Inventory.quantity < threshold
            ).all()
        finally:
            session.close()

# ä½¿ç”¨ç¤ºä¾‹
manager = InventoryManager('sqlite:///inventory.db')

# æ·»åŠ ç”¢å“
manager.add_product("Python Book", 100, 29.99)
manager.add_product("Java Book", 50, 34.99)

# æ›´æ–°åº«å­˜
manager.update_quantity(1, -10)  # æ¸›å°‘10æœ¬Pythonæ›¸

# æª¢æŸ¥ä½åº«å­˜ç”¢å“
low_stock = manager.get_low_stock_products(20)
for product in low_stock:
    print(f"ä½åº«å­˜è­¦å‘Šï¼š{product.product_name} (å‰©é¤˜ï¼š{product.quantity})")
```

### 2. ç”¨æˆ¶æ´»å‹•æ—¥èªŒç³»çµ±

```python
from sqlalchemy import create_engine, Column, Integer, String, DateTime, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime

Base = declarative_base()

class ActivityLog(Base):
    __tablename__ = 'activity_logs'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(String(50))
    action = Column(String(100))
    details = Column(Text)
    timestamp = Column(DateTime, default=datetime.now)
    
    def __repr__(self):
        return f"<ActivityLog(user='{self.user_id}', action='{self.action}')>"

class ActivityLogger:
    def __init__(self, db_url):
        self.engine = create_engine(db_url)
        Base.metadata.create_all(self.engine)
        self.Session = sessionmaker(bind=self.engine)
    
    def log_activity(self, user_id, action, details=None):
        session = self.Session()
        try:
            log = ActivityLog(
                user_id=user_id,
                action=action,
                details=details
            )
            session.add(log)
            session.commit()
        except Exception as e:
            session.rollback()
            print(f"è¨˜éŒ„æ´»å‹•å¤±æ•—ï¼š{e}")
        finally:
            session.close()
    
    def get_user_activities(self, user_id, limit=10):
        session = self.Session()
        try:
            return session.query(ActivityLog)\
                .filter_by(user_id=user_id)\
                .order_by(ActivityLog.timestamp.desc())\
                .limit(limit)\
                .all()
        finally:
            session.close()
    
    def get_recent_activities(self, limit=20):
        session = self.Session()
        try:
            return session.query(ActivityLog)\
                .order_by(ActivityLog.timestamp.desc())\
                .limit(limit)\
                .all()
        finally:
            session.close()

# ä½¿ç”¨ç¤ºä¾‹
logger = ActivityLogger('sqlite:///activity.db')

# è¨˜éŒ„æ´»å‹•
logger.log_activity('user123', 'login', 'å¾ 192.168.1.100 ç™»å…¥')
logger.log_activity('user123', 'view_profile', 'æŸ¥çœ‹å€‹äººè³‡æ–™')
logger.log_activity('user456', 'update_settings', 'æ›´æ–°éƒµä»¶é€šçŸ¥è¨­ç½®')

# ç²å–ç‰¹å®šç”¨æˆ¶çš„æ´»å‹•
activities = logger.get_user_activities('user123')
for activity in activities:
    print(f"{activity.timestamp}: {activity.action} - {activity.details}")

# ç²å–æœ€è¿‘çš„æ´»å‹•
recent = logger.get_recent_activities()
for activity in recent:
    print(f"{activity.user_id} - {activity.action} ({activity.timestamp})")
```

## ç·´ç¿’é¡Œ

1. **å­¸ç”Ÿæˆç¸¾ç®¡ç†ç³»çµ±**
   å¯¦ç¾ä¸€å€‹æˆç¸¾ç®¡ç†ç³»çµ±ï¼š
   - æ·»åŠ /åˆªé™¤å­¸ç”Ÿ
   - è¨˜éŒ„è€ƒè©¦æˆç¸¾
   - è¨ˆç®—å¹³å‡åˆ†
   - ç”Ÿæˆæˆç¸¾å ±å‘Š

2. **é›»å­å•†å‹™æ•¸æ“šåº«**
   å‰µå»ºä¸€å€‹ç°¡å–®çš„é›»å•†æ•¸æ“šåº«ï¼š
   - å•†å“ç®¡ç†
   - è¨‚å–®è™•ç†
   - ç”¨æˆ¶ç®¡ç†
   - è³¼ç‰©è»ŠåŠŸèƒ½

3. **åšå®¢ç³»çµ±å¾Œç«¯**
   é–‹ç™¼ä¸€å€‹åšå®¢ç³»çµ±çš„æ•¸æ“šåº«éƒ¨åˆ†ï¼š
   - æ–‡ç« ç®¡ç†
   - ç”¨æˆ¶è©•è«–
   - æ¨™ç±¤åˆ†é¡
   - è¨ªå•çµ±è¨ˆ

## å°æé†’ ğŸ’¡

1. æ­£ç¢ºè™•ç†æ•¸æ“šåº«é€£æ¥
2. ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢é˜²æ­¢ SQL æ³¨å…¥
3. é©ç•¶ä½¿ç”¨äº‹å‹™ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
4. æ³¨æ„æ•¸æ“šåº«æ€§èƒ½å„ªåŒ–
5. å®šæœŸå‚™ä»½é‡è¦æ•¸æ“š
6. ä½¿ç”¨åˆé©çš„ç´¢å¼•æå‡æŸ¥è©¢æ•ˆç‡

[ä¸Šä¸€ç« ï¼šç¶²è·¯ç¨‹å¼è¨­è¨ˆåŸºç¤](039_ç¶²è·¯ç¨‹å¼è¨­è¨ˆåŸºç¤.md) 