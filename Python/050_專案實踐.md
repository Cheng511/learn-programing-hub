[ä¸Šä¸€ç« ï¼šé€²éšå–®å…ƒæ¸¬è©¦](049_é€²éšå–®å…ƒæ¸¬è©¦.md)

# Python å°ˆæ¡ˆå¯¦è¸ ğŸš€

## å°ˆæ¡ˆçµæ§‹

### 1. æ¨™æº–å°ˆæ¡ˆçµæ§‹

```plaintext
my_project/
â”‚
â”œâ”€â”€ docs/                    # æ–‡æª”ç›®éŒ„
â”‚   â”œâ”€â”€ api.md              # API æ–‡æª”
â”‚   â””â”€â”€ user_guide.md       # ç”¨æˆ¶æŒ‡å—
â”‚
â”œâ”€â”€ src/                    # æºä»£ç¢¼ç›®éŒ„
â”‚   â””â”€â”€ my_project/         # ä¸»è¦åŒ…ç›®éŒ„
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ core/           # æ ¸å¿ƒåŠŸèƒ½
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ main.py
â”‚       â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•¸
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ helpers.py
â”‚       â””â”€â”€ config/         # é…ç½®æ–‡ä»¶
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ settings.py
â”‚
â”œâ”€â”€ tests/                  # æ¸¬è©¦ç›®éŒ„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_core.py
â”‚   â””â”€â”€ test_utils.py
â”‚
â”œâ”€â”€ requirements.txt        # ä¾è³´åŒ…åˆ—è¡¨
â”œâ”€â”€ setup.py               # å®‰è£è…³æœ¬
â”œâ”€â”€ README.md              # é …ç›®èªªæ˜
â””â”€â”€ .gitignore            # Git å¿½ç•¥æ–‡ä»¶
```

### 2. é…ç½®ç®¡ç†

```python
# config/settings.py
import os
from pathlib import Path
from typing import Dict, Any

class Config:
    # åŸºç¤é…ç½®
    BASE_DIR = Path(__file__).parent.parent
    
    # æ•¸æ“šåº«é…ç½®
    DB_HOST = os.getenv('DB_HOST', 'localhost')
    DB_PORT = int(os.getenv('DB_PORT', 5432))
    DB_NAME = os.getenv('DB_NAME', 'mydb')
    DB_USER = os.getenv('DB_USER', 'user')
    DB_PASSWORD = os.getenv('DB_PASSWORD', 'password')
    
    # API é…ç½®
    API_VERSION = '1.0'
    API_PREFIX = '/api/v1'
    
    # æ—¥èªŒé…ç½®
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')
    LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    
    @classmethod
    def get_db_url(cls) -> str:
        return f"postgresql://{cls.DB_USER}:{cls.DB_PASSWORD}@{cls.DB_HOST}:{cls.DB_PORT}/{cls.DB_NAME}"
    
    @classmethod
    def to_dict(cls) -> Dict[str, Any]:
        return {
            key: value for key, value in cls.__dict__.items()
            if not key.startswith('__') and not callable(value)
        }

# ä½¿ç”¨ç¤ºä¾‹
config = Config()
db_url = config.get_db_url()
settings = config.to_dict()
```

## ä¾è³´ç®¡ç†

### 1. ä½¿ç”¨ requirements.txt

```plaintext
# requirements.txt
flask==2.0.1
sqlalchemy==1.4.23
psycopg2-binary==2.9.1
python-dotenv==0.19.0
pytest==6.2.5
black==21.7b0
mypy==0.910
```

### 2. ä½¿ç”¨ setup.py

```python
# setup.py
from setuptools import setup, find_packages

setup(
    name="my_project",
    version="1.0.0",
    packages=find_packages(where="src"),
    package_dir={"": "src"},
    
    # ä¾è³´ç®¡ç†
    install_requires=[
        "flask>=2.0.0",
        "sqlalchemy>=1.4.0",
        "psycopg2-binary>=2.9.0",
    ],
    
    # é–‹ç™¼ä¾è³´
    extras_require={
        "dev": [
            "pytest>=6.0.0",
            "black>=21.0.0",
            "mypy>=0.900",
        ],
    },
    
    # é …ç›®å…ƒæ•¸æ“š
    author="Your Name",
    author_email="your.email@example.com",
    description="A sample Python project",
    long_description=open("README.md").read(),
    long_description_content_type="text/markdown",
    url="https://github.com/yourusername/my_project",
    classifiers=[
        "Development Status :: 3 - Alpha",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: MIT License",
        "Programming Language :: Python :: 3",
        "Programming Language :: Python :: 3.8",
        "Programming Language :: Python :: 3.9",
    ],
    python_requires=">=3.8",
)
```

## ä»£ç¢¼å“è³ª

### 1. ä»£ç¢¼é¢¨æ ¼

```python
# ä½¿ç”¨ Black æ ¼å¼åŒ–å·¥å…·
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'
extend-exclude = '''
# A regex preceded with ^/ will apply only to files and directories
# in the root of the project.
^/tests/
'''

# ä½¿ç”¨ flake8
# setup.cfg
[flake8]
max-line-length = 88
extend-ignore = E203
exclude = .git,__pycache__,build,dist

# ä½¿ç”¨ mypy é€²è¡Œé¡å‹æª¢æŸ¥
# mypy.ini
[mypy]
python_version = 3.8
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True

[mypy.plugins.django.*]
init_typed = True
```

### 2. ä»£ç¢¼æª¢æŸ¥å·¥å…·

```python
# pre-commit é…ç½®
# .pre-commit-config.yaml
repos:
-   repo: https://github.com/psf/black
    rev: 21.7b0
    hooks:
    -   id: black
        language_version: python3.8
-   repo: https://github.com/pycqa/flake8
    rev: 3.9.2
    hooks:
    -   id: flake8
-   repo: https://github.com/pre-commit/mirrors-mypy
    rev: v0.910
    hooks:
    -   id: mypy
        additional_dependencies: [types-all]
```

## æ—¥èªŒè™•ç†

### 1. æ—¥èªŒé…ç½®

```python
# utils/logger.py
import logging
import sys
from logging.handlers import RotatingFileHandler
from pathlib import Path
from typing import Optional

def setup_logger(
    name: str,
    log_file: Optional[Path] = None,
    level: int = logging.INFO
) -> logging.Logger:
    """è¨­ç½®æ—¥èªŒè¨˜éŒ„å™¨"""
    
    # å‰µå»ºæ—¥èªŒè¨˜éŒ„å™¨
    logger = logging.getLogger(name)
    logger.setLevel(level)
    
    # å‰µå»ºæ ¼å¼åŒ–å™¨
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # æ·»åŠ æ§åˆ¶å°è™•ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)
    
    # å¦‚æœæŒ‡å®šäº†æ—¥èªŒæ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶è™•ç†å™¨
    if log_file:
        file_handler = RotatingFileHandler(
            log_file,
            maxBytes=10*1024*1024,  # 10MB
            backupCount=5
        )
        file_handler.setFormatter(formatter)
        logger.addHandler(file_handler)
    
    return logger

# ä½¿ç”¨ç¤ºä¾‹
logger = setup_logger(
    "my_project",
    Path("logs/app.log"),
    logging.DEBUG
)

logger.debug("Debug message")
logger.info("Info message")
logger.warning("Warning message")
logger.error("Error message")
```

### 2. æ—¥èªŒä½¿ç”¨

```python
# core/main.py
from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)

class UserService:
    def __init__(self):
        self.users: Dict[int, Dict[str, Any]] = {}
    
    def create_user(self, user_data: Dict[str, Any]) -> int:
        try:
            user_id = len(self.users) + 1
            self.users[user_id] = user_data
            logger.info(f"Created user with ID: {user_id}")
            return user_id
        except Exception as e:
            logger.error(f"Failed to create user: {str(e)}")
            raise
    
    def get_user(self, user_id: int) -> Dict[str, Any]:
        try:
            user = self.users.get(user_id)
            if user:
                logger.debug(f"Retrieved user: {user_id}")
                return user
            logger.warning(f"User not found: {user_id}")
            return {}
        except Exception as e:
            logger.error(f"Error retrieving user {user_id}: {str(e)}")
            raise
```

## éŒ¯èª¤è™•ç†

### 1. è‡ªå®šç¾©ç•°å¸¸

```python
# exceptions.py
class AppError(Exception):
    """åŸºç¤ç•°å¸¸é¡"""
    def __init__(self, message: str, code: str = None):
        self.message = message
        self.code = code
        super().__init__(self.message)

class ValidationError(AppError):
    """é©—è­‰éŒ¯èª¤"""
    pass

class NotFoundError(AppError):
    """è³‡æºæœªæ‰¾åˆ°"""
    pass

class DatabaseError(AppError):
    """æ•¸æ“šåº«éŒ¯èª¤"""
    pass

# ä½¿ç”¨ç¤ºä¾‹
def validate_user_data(data: dict) -> None:
    if not data.get('email'):
        raise ValidationError("Email is required", "INVALID_EMAIL")
    
    if not data.get('password'):
        raise ValidationError("Password is required", "INVALID_PASSWORD")

def get_user_by_id(user_id: int) -> dict:
    try:
        # å‡è¨­é€™æ˜¯æ•¸æ“šåº«æ“ä½œ
        user = None  # æ•¸æ“šåº«æŸ¥è©¢
        if not user:
            raise NotFoundError(f"User {user_id} not found", "USER_NOT_FOUND")
        return user
    except Exception as e:
        raise DatabaseError(f"Database error: {str(e)}", "DB_ERROR")
```

### 2. éŒ¯èª¤è™•ç†ä¸­é–“ä»¶

```python
# middleware.py
from typing import Callable, Any
from flask import Flask, jsonify, Request, Response
from werkzeug.exceptions import HTTPException
from .exceptions import AppError

def setup_error_handlers(app: Flask) -> None:
    @app.errorhandler(AppError)
    def handle_app_error(error: AppError) -> Response:
        response = {
            "error": {
                "code": error.code or "UNKNOWN_ERROR",
                "message": error.message
            }
        }
        return jsonify(response), 400
    
    @app.errorhandler(HTTPException)
    def handle_http_error(error: HTTPException) -> Response:
        response = {
            "error": {
                "code": str(error.code),
                "message": error.description
            }
        }
        return jsonify(response), error.code
    
    @app.errorhandler(Exception)
    def handle_generic_error(error: Exception) -> Response:
        response = {
            "error": {
                "code": "INTERNAL_ERROR",
                "message": "An internal error occurred"
            }
        }
        return jsonify(response), 500

# ä½¿ç”¨ç¤ºä¾‹
app = Flask(__name__)
setup_error_handlers(app)

@app.route('/api/users/<int:user_id>')
def get_user(user_id: int) -> Response:
    try:
        user = get_user_by_id(user_id)
        return jsonify(user)
    except AppError as e:
        raise
    except Exception as e:
        app.logger.error(f"Unexpected error: {str(e)}")
        raise
```

## éƒ¨ç½²

### 1. Docker éƒ¨ç½²

```dockerfile
# Dockerfile
FROM python:3.9-slim

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ä¾è³´æ–‡ä»¶
COPY requirements.txt .

# å®‰è£ä¾è³´
RUN pip install --no-cache-dir -r requirements.txt

# è¤‡è£½æ‡‰ç”¨ä»£ç¢¼
COPY . .

# è¨­ç½®ç’°å¢ƒè®Šé‡
ENV PYTHONPATH=/app/src
ENV FLASK_APP=my_project.app
ENV FLASK_ENV=production

# æš´éœ²ç«¯å£
EXPOSE 5000

# å•Ÿå‹•å‘½ä»¤
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "my_project.app:app"]

# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DB_HOST=db
      - DB_NAME=mydb
      - DB_USER=user
      - DB_PASSWORD=password
    depends_on:
      - db
  
  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 2. ç³»çµ±æœå‹™

```ini
# /etc/systemd/system/myproject.service
[Unit]
Description=My Python Project
After=network.target

[Service]
User=myuser
Group=myuser
WorkingDirectory=/opt/my_project
Environment="PATH=/opt/my_project/venv/bin"
ExecStart=/opt/my_project/venv/bin/gunicorn --workers 4 --bind unix:myproject.sock -m 007 my_project.app:app

[Install]
WantedBy=multi-user.target

# Nginx é…ç½®
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://unix:/opt/my_project/myproject.sock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ç›£æ§å’Œç¶­è­·

### 1. å¥åº·æª¢æŸ¥

```python
# health.py
import psutil
import time
from typing import Dict, Any

def check_system_health() -> Dict[str, Any]:
    """ç³»çµ±å¥åº·æª¢æŸ¥"""
    return {
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_usage": psutil.disk_usage('/').percent,
        "timestamp": int(time.time())
    }

def check_database_health(db_session) -> bool:
    """æ•¸æ“šåº«å¥åº·æª¢æŸ¥"""
    try:
        # åŸ·è¡Œç°¡å–®æŸ¥è©¢
        db_session.execute("SELECT 1")
        return True
    except Exception:
        return False

# API ç«¯é»
@app.route('/health')
def health_check():
    health_status = {
        "status": "healthy",
        "system": check_system_health(),
        "database": check_database_health(db.session)
    }
    
    if not health_status["database"]:
        health_status["status"] = "unhealthy"
        return jsonify(health_status), 500
    
    return jsonify(health_status)
```

### 2. æ€§èƒ½ç›£æ§

```python
# monitoring.py
from functools import wraps
import time
import statistics
from typing import List, Callable, Any

class PerformanceMonitor:
    def __init__(self):
        self.metrics: Dict[str, List[float]] = {}
    
    def record(self, name: str, value: float) -> None:
        """è¨˜éŒ„æ€§èƒ½æŒ‡æ¨™"""
        if name not in self.metrics:
            self.metrics[name] = []
        self.metrics[name].append(value)
    
    def get_stats(self, name: str) -> Dict[str, float]:
        """ç²å–æ€§èƒ½çµ±è¨ˆ"""
        values = self.metrics.get(name, [])
        if not values:
            return {}
        
        return {
            "count": len(values),
            "avg": statistics.mean(values),
            "min": min(values),
            "max": max(values),
            "median": statistics.median(values)
        }
    
    def clear(self) -> None:
        """æ¸…é™¤æ‰€æœ‰æŒ‡æ¨™"""
        self.metrics.clear()

# å‰µå»ºç›£æ§å™¨å¯¦ä¾‹
monitor = PerformanceMonitor()

def measure_time(func: Callable) -> Callable:
    """æ¸¬é‡å‡½æ•¸åŸ·è¡Œæ™‚é–“çš„è£é£¾å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs) -> Any:
        start_time = time.time()
        result = func(*args, **kwargs)
        elapsed_time = time.time() - start_time
        
        # è¨˜éŒ„åŸ·è¡Œæ™‚é–“
        monitor.record(func.__name__, elapsed_time)
        
        return result
    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@measure_time
def process_data(data: List[Any]) -> None:
    time.sleep(0.1)  # æ¨¡æ“¬è™•ç†æ™‚é–“
    # è™•ç†æ•¸æ“š...

# å®šæœŸå ±å‘Š
def generate_performance_report() -> Dict[str, Any]:
    return {
        name: monitor.get_stats(name)
        for name in monitor.metrics
    }
```

## å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### 1. RESTful API æœå‹™

```python
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from typing import Dict, Any

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql://user:pass@localhost/db'
db = SQLAlchemy(app)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)

@app.route('/api/users', methods=['POST'])
def create_user() -> Dict[str, Any]:
    data = request.get_json()
    
    try:
        user = User(
            username=data['username'],
            email=data['email']
        )
        db.session.add(user)
        db.session.commit()
        
        return jsonify({
            "id": user.id,
            "username": user.username,
            "email": user.email
        }), 201
    
    except Exception as e:
        db.session.rollback()
        return jsonify({
            "error": str(e)
        }), 400

@app.route('/api/users/<int:user_id>', methods=['GET'])
def get_user(user_id: int) -> Dict[str, Any]:
    user = User.query.get_or_404(user_id)
    return jsonify({
        "id": user.id,
        "username": user.username,
        "email": user.email
    })

if __name__ == '__main__':
    app.run(debug=True)
```

### 2. æ•¸æ“šè™•ç†ç®¡é“

```python
from typing import List, Dict, Any
import pandas as pd
from abc import ABC, abstractmethod

class DataProcessor(ABC):
    @abstractmethod
    def process(self, data: pd.DataFrame) -> pd.DataFrame:
        pass

class DataCleaner(DataProcessor):
    def process(self, data: pd.DataFrame) -> pd.DataFrame:
        # æ¸…ç†æ•¸æ“š
        data = data.dropna()
        data = data.drop_duplicates()
        return data

class DataTransformer(DataProcessor):
    def process(self, data: pd.DataFrame) -> pd.DataFrame:
        # è½‰æ›æ•¸æ“š
        data['date'] = pd.to_datetime(data['date'])
        data['amount'] = data['amount'].astype(float)
        return data

class DataAggregator(DataProcessor):
    def process(self, data: pd.DataFrame) -> pd.DataFrame:
        # èšåˆæ•¸æ“š
        return data.groupby('category').agg({
            'amount': ['sum', 'mean', 'count']
        }).reset_index()

class Pipeline:
    def __init__(self, steps: List[DataProcessor]):
        self.steps = steps
    
    def run(self, data: pd.DataFrame) -> pd.DataFrame:
        result = data.copy()
        for step in self.steps:
            result = step.process(result)
        return result

# ä½¿ç”¨ç¤ºä¾‹
def process_sales_data(file_path: str) -> Dict[str, Any]:
    # è®€å–æ•¸æ“š
    data = pd.read_csv(file_path)
    
    # å‰µå»ºè™•ç†ç®¡é“
    pipeline = Pipeline([
        DataCleaner(),
        DataTransformer(),
        DataAggregator()
    ])
    
    # è™•ç†æ•¸æ“š
    result = pipeline.run(data)
    
    # è¿”å›çµæœ
    return {
        "summary": result.to_dict('records'),
        "total_sales": result['amount']['sum'].sum(),
        "total_transactions": result['amount']['count'].sum()
    }
```

## ç·´ç¿’é¡Œ

1. **å®Œæ•´çš„ Web æ‡‰ç”¨**
   å¯¦ç¾ä¸€å€‹ç°¡å–®çš„åšå®¢ç³»çµ±ï¼š
   - ç”¨æˆ¶èªè­‰å’Œæˆæ¬Š
   - æ–‡ç« çš„ CRUD æ“ä½œ
   - è©•è«–åŠŸèƒ½
   - æ–‡ä»¶ä¸Šå‚³

2. **æ•¸æ“šè™•ç†ç³»çµ±**
   å‰µå»ºä¸€å€‹æ•¸æ“šè™•ç†ç³»çµ±ï¼š
   - æ•¸æ“šå°å…¥å’Œé©—è­‰
   - æ•¸æ“šè½‰æ›å’Œæ¸…ç†
   - æ•¸æ“šåˆ†æå’Œå ±å‘Š
   - çµæœå°å‡º

3. **è‡ªå‹•åŒ–å·¥å…·**
   é–‹ç™¼ä¸€å€‹è‡ªå‹•åŒ–å·¥å…·ï¼š
   - æ–‡ä»¶è™•ç†
   - ä»»å‹™èª¿åº¦
   - çµæœé€šçŸ¥
   - éŒ¯èª¤è™•ç†

## å°æé†’ ğŸ’¡

1. é …ç›®è¦åŠƒ
   - æ˜ç¢ºéœ€æ±‚å’Œç›®æ¨™
   - é¸æ“‡åˆé©çš„æŠ€è¡“æ£§
   - åˆ¶å®šé–‹ç™¼è¨ˆåŠƒ
   - è¨­ç½®é …ç›®é‡Œç¨‹ç¢‘

2. ä»£ç¢¼ç®¡ç†
   - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶
   - éµå¾ªä»£ç¢¼è¦ç¯„
   - é€²è¡Œä»£ç¢¼å¯©æŸ¥
   - ä¿æŒæ–‡æª”æ›´æ–°

3. æ¸¬è©¦å’Œéƒ¨ç½²
   - ç·¨å¯«å®Œæ•´çš„æ¸¬è©¦
   - è‡ªå‹•åŒ–éƒ¨ç½²æµç¨‹
   - ç›£æ§ç³»çµ±é‹è¡Œ
   - å®šæœŸç¶­è­·æ›´æ–°

4. æœ€ä½³å¯¦è¸
   - æ¨¡å¡ŠåŒ–è¨­è¨ˆ
   - éŒ¯èª¤è™•ç†
   - æ€§èƒ½å„ªåŒ–
   - å®‰å…¨æ€§è€ƒæ…®

[ä¸Šä¸€ç« ï¼šé€²éšå–®å…ƒæ¸¬è©¦](049_é€²éšå–®å…ƒæ¸¬è©¦.md) 